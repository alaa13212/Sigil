@using Sigil.Application.Models.NormalizationRules
@using Sigil.Domain.Entities
@using Sigil.Domain.Interfaces
@inject INormalizationRuleService NormalizationService
@inject IMessageNormalizer MessageNormalizer

<ModalBase IsOpen="IsOpen" OnClose="OnClosed"
           Title="@(EditingRule is null ? "New Normalization Rule" : "Edit Normalization Rule")"
           Size="ModalSize.Medium">
    <div class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <fieldset class="fieldset">
                <legend class="fieldset-legend">Pattern <span class="opacity-50">(regex)</span></legend>
                <input type="text" class="input input-sm w-full font-mono"
                       placeholder="e.g. \border-\d+"
                       @bind="_pattern" />
            </fieldset>

            <fieldset class="fieldset">
                <legend class="fieldset-legend">Replacement</legend>
                <input type="text" class="input input-sm w-full font-mono"
                       placeholder="e.g. {order_id}"
                       @bind="_replacement" />
            </fieldset>

            <fieldset class="fieldset">
                <legend class="fieldset-legend">Priority</legend>
                <input type="number" class="input input-sm w-full" @bind="_priority" min="0" />
                <p class="fieldset-label text-xs">Lower number = applied first</p>
            </fieldset>

            <fieldset class="fieldset sm:col-span-2">
                <legend class="fieldset-legend">Description <span class="opacity-50">(optional)</span></legend>
                <input type="text" class="input input-sm w-full"
                       placeholder="What does this rule normalize?"
                       @bind="_description" />
            </fieldset>
        </div>

        <!-- Preview -->
        <div class="space-y-2">
            <div class="flex gap-2">
                <input type="text" class="input input-sm flex-1 font-mono"
                       placeholder="Test message…"
                       @bind="_previewInput" />
                <button class="btn btn-ghost btn-sm" @onclick="RunPreview">Preview</button>
            </div>
            @if (_previewResult is not null)
            {
                <div class="bg-base-300 rounded p-3 font-mono text-sm break-all">@_previewResult</div>
            }
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="alert alert-error text-sm py-2">@_error</div>
        }

        <div class="modal-action">
            <button class="btn btn-ghost" @onclick="() => OnClosed.InvokeAsync()">Cancel</button>
            <button class="btn btn-primary" @onclick="Save" disabled="@_saving">
                @(_saving ? "Saving…" : (EditingRule is null ? "Add Rule" : "Save"))
            </button>
        </div>
    </div>
</ModalBase>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter, EditorRequired] public int ProjectId { get; set; }
    [Parameter] public TextNormalizationRule? EditingRule { get; set; }
    [Parameter] public List<TextNormalizationRule> AllRules { get; set; } = [];
    [Parameter] public EventCallback<TextNormalizationRule> OnSaved { get; set; }
    [Parameter] public EventCallback OnClosed { get; set; }

    private string _pattern = "";
    private string _replacement = "";
    private int _priority;
    private string? _description;
    private string _previewInput = "";
    private string? _previewResult;
    private string _error = "";
    private bool _saving;

    protected override void OnParametersSet()
    {
        if (!IsOpen) return;
        if (EditingRule is not null)
        {
            _pattern = EditingRule.Pattern;
            _replacement = EditingRule.Replacement;
            _priority = EditingRule.Priority;
            _description = EditingRule.Description;
        }
        else
        {
            _pattern = ""; _replacement = ""; _priority = 0; _description = null;
        }
        _previewResult = null;
        _error = "";
    }

    private void RunPreview()
    {
        _previewResult = MessageNormalizer.NormalizeMessage(AllRules, _previewInput);
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(_pattern))     { _error = "Pattern is required."; return; }
        if (string.IsNullOrWhiteSpace(_replacement)) { _error = "Replacement is required."; return; }

        _saving = true;
        _error = "";
        try
        {
            TextNormalizationRule result;
            if (EditingRule is null)
            {
                var req = new CreateNormalizationRuleRequest(_pattern.Trim(), _replacement.Trim(), _priority, true, _description?.Trim());
                result = await NormalizationService.CreateRuleAsync(ProjectId, req);
            }
            else
            {
                var req = new UpdateNormalizationRuleRequest(_pattern.Trim(), _replacement.Trim(), _priority, EditingRule.Enabled, _description?.Trim());
                result = await NormalizationService.UpdateRuleAsync(EditingRule.Id, req)
                         ?? throw new InvalidOperationException("Rule not found.");
            }
            await OnSaved.InvokeAsync(result);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }
}
