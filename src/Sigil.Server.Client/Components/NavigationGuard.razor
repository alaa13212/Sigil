@inject NavigationManager Navigation
@inject ISetupService SetupService
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

@if (_ready)
{
    @ChildContent
}
else
{
    <div class="flex items-center justify-center min-h-screen">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
}

@code {
    private const string SetupWizardPath = "/setup";
    private const string LoginPath = "/login";
    private const string ActivatePath = "/activate";
    private const string MigrationsPath = "/admin/migrations";
    
    [Parameter] public RenderFragment ChildContent { get; set; } = null!;

    private bool _ready;
    private IDisposable? _locationHandler;
    
    protected override async Task OnInitializedAsync()
    {
        _locationHandler = Navigation.RegisterLocationChangingHandler(OnLocationChanging);
        await GuardInitialAsync();
    }

    private async ValueTask OnLocationChanging(LocationChangingContext context)
    {
        var redirect = await GetRedirectFor(context.TargetLocation);
        if (redirect is not null)
        {
            context.PreventNavigation();
            Navigation.NavigateTo(redirect);
        }
    }

    private async Task GuardInitialAsync()
    {
        var redirect = await GetRedirectFor(Navigation.Uri);
        if (redirect is not null)
        {
            Navigation.NavigateTo(redirect, forceLoad: true);
            return;
        }

        _ready = true;
    }

    private async Task<string?> GetRedirectFor(string uri)
    {
        string path = Path.Combine( "/", uri.StartsWith(Navigation.BaseUri, StringComparison.OrdinalIgnoreCase)? Navigation.ToBaseRelativePath(uri) : uri);
        if(path.StartsWith(SetupWizardPath, StringComparison.OrdinalIgnoreCase))
            return null;
        
        var setupStatus = await SetupService.GetSetupStatusAsync();
        if (!setupStatus.IsComplete)
            return SetupWizardPath;
        

        if (path.StartsWith(LoginPath, StringComparison.OrdinalIgnoreCase))
            return null;

        if (path.StartsWith(ActivatePath, StringComparison.OrdinalIgnoreCase))
            return null;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated != true)
        {
            var returnUrl = path == "/" ? "" : $"?returnUrl={Uri.EscapeDataString(path)}";
            return $"{LoginPath}{returnUrl}";
        }

        if (!path.StartsWith(MigrationsPath, StringComparison.OrdinalIgnoreCase))
        {
            if (await SetupService.HasPendingMigrationsAsync())
                return MigrationsPath;
        }

        return null;
    }

    public void Dispose() => _locationHandler?.Dispose();
}
