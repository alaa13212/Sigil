@using Sigil.Application.Models.Events

<!-- Navigation bar -->
<div class="space-y-4">
    
    <div class="flex items-center gap-3 text-sm opacity-60">
        <SeverityBadge Level="EventDetail.Level" />
        <RelativeTime Value="EventDetail.Timestamp" />
        <span>Â·</span>
        <span>@EventDetail.Timestamp.ToString("yyyy-MM-dd HH:mm:ss UTC")</span>
        <div class="grow"></div>
        <code class="text-xs opacity-50">EventId: @EventDetail.EventId</code>
    </div>
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <button class="btn btn-ghost btn-sm" disabled="@(Navigation?.PreviousEventId is null || Navigating)"
                    @onclick="() => OnNavigateEvent.InvokeAsync(Navigation!.PreviousEventId!.Value)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Older
            </button>
            <TabBar TTab="EventTab" Tabs="_eventTabs" ActiveTab="_activeEventTab" TabLabel="GetEventTabLabel" TabParamName="etab" Class="tabs-border"/>
            <button class="btn btn-ghost btn-sm" disabled="@(Navigation?.NextEventId is null || Navigating)"
                    @onclick="() => OnNavigateEvent.InvokeAsync(Navigation!.NextEventId!.Value)">
                Newer
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
    </div>



    @if (_activeEventTab == EventTab.Details)
    {
        <div class="alert bg-base-300 flex flex-row flex-wrap items-start gap-2">
            @if (!string.IsNullOrEmpty(EventDetail.ExceptionType))
            {
                <div class="font-mono text-sm font-semibold opacity-70">@EventDetail.ExceptionType</div>
            }
            @if (!string.IsNullOrEmpty(EventDetail.Message))
            {
                <div class="font-mono text-sm break-words grow-1">@EventDetail.Message</div>
            }
            else if (string.IsNullOrEmpty(EventDetail.ExceptionType))
            {
                <div class="opacity-50 italic text-sm">No message</div>
            }
            @if (!string.IsNullOrEmpty(EventDetail.Culprit))
            {
                <div class="text-xs opacity-50 mt-0.5">@EventDetail.Culprit</div>
            }
        </div>

        @if (EventDetail.StackFrames.Count > 0)
        {
            <div class="card bg-base-300">
                <div class="card-body p-4 overflow-auto">
                    <h2 class="card-title text-base">Stack Trace</h2>
                    <StackTraceViewer Frames="EventDetail.StackFrames" Platform="EventDetail.Platform"/>
                </div>
            </div>
        }

        @if (EventDetail.Exceptions is { Count: > 1 })
        {
            var others = EventDetail.Exceptions.Where(e => !e.IsPrimary).ToList();
            <div class="card bg-base-300">
                <div class="card-body p-4">
                    <div class="collapse collapse-arrow bg-base-100 border-base-300 border">
                        <input type="checkbox"/>
                        <div class="collapse-title font-semibold">+@others.Count More Exception@(others.Count == 1 ? "" : "s")</div>
                        <div class="collapse-content text-sm">
                            <div class="mt-3 space-y-3">
                                @foreach (var ex in others)
                                {
                                    <div class="border-l-2 border-base-content/20 pl-4">
                                        <div class="font-mono text-sm font-semibold opacity-70">@ex.Type</div>
                                        @if (!string.IsNullOrEmpty(ex.Value))
                                        {
                                            <div class="font-mono text-sm break-words opacity-60">@ex.Value</div>
                                        }
                                        @if (ex.StackFrames.Count > 0)
                                        {
                                            <div class="mt-2">
                                                <StackTraceViewer Frames="ex.StackFrames" Platform="EventDetail.Platform"/>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <EventContextCards EventDetail="EventDetail" ProjectId="ProjectId"/>
    }
    else if (_activeEventTab == EventTab.Breadcrumbs)
    {
        @if (Breadcrumbs is { Count: > 0 })
        {
            <div class="card bg-base-300">
                <div class="card-body p-4">
                    <BreadcrumbsViewer Breadcrumbs="Breadcrumbs" EventTimestamp="EventDetail.Timestamp"/>
                </div>
            </div>
        }
        else
        {
            <EmptyState Title="No breadcrumbs" Description="This event has no breadcrumbs."/>
        }
    }
    else if (_activeEventTab == EventTab.Raw)
    {
        <RawJsonViewer EventId="EventDetail.Id" AutoLoad="true" @key="EventDetail.Id"/>
    }
</div>

@code {
    [Parameter, EditorRequired] public int ProjectId { get; set; }
    [Parameter, EditorRequired] public int IssueId { get; set; }
    [Parameter, EditorRequired] public EventDetailResponse EventDetail { get; set; } = default!;
    [Parameter] public EventNavigationResponse? Navigation { get; set; }
    [Parameter] public List<BreadcrumbResponse>? Breadcrumbs { get; set; }
    [Parameter] public bool Navigating { get; set; }
    [Parameter] public EventCallback<long> OnNavigateEvent { get; set; }
    [SupplyParameterFromQuery(Name = "etab")] public string? EventTabParam { get; set; }
    
    private enum EventTab { Details, Breadcrumbs, Raw }
    private static readonly EventTab[] _eventTabs = [EventTab.Details, EventTab.Breadcrumbs, EventTab.Raw];

    private EventTab _activeEventTab => EventTabParam switch
    {
        nameof(EventTab.Breadcrumbs) => EventTab.Breadcrumbs,
        nameof(EventTab.Raw)         => EventTab.Raw,
        _                            => EventTab.Details
    };

    private static string GetEventTabLabel(EventTab tab) => tab switch
    {
        EventTab.Details     => "Details",
        EventTab.Breadcrumbs => "Breadcrumbs",
        EventTab.Raw         => "Raw JSON",
        _                    => tab.ToString()
    };
}
