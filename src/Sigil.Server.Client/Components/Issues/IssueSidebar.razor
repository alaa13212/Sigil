@using Sigil.Application.Models.Issues
@using Sigil.Domain
@inject IIssueService IssueService
@inject ITagValueFormatter TagValueFormatter

<div class="w-full lg:w-72 space-y-4">
    <!-- Status + Priority -->
    <div class="card bg-base-200">
        <div class="card-body p-0 divide-y divide-base-300">
            <!-- Status row -->
            <div class="dropdown dropdown-end w-full">
                <label tabindex="0" class="btn btn-ghost btn-sm w-full justify-between rounded-t-2xl rounded-b-none px-4 h-11" aria-disabled="@_loading">
                    <span class="text-sm opacity-60">Status</span>
                    <div class="flex items-center gap-1.5">
                        <StatusBadge Status="Issue.Status" />
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </label>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-full shadow z-10 p-1">
                    @if (Issue.Status != IssueStatus.Open)
                    {
                        <li><button @onclick="() => UpdateStatus(IssueStatus.Open)" disabled="@_loading">Reopen</button></li>
                    }
                    @if (Issue.Status != IssueStatus.Resolved)
                    {
                        <li><button @onclick="() => UpdateStatus(IssueStatus.Resolved)" disabled="@_loading">Resolve</button></li>
                    }
                    @if (Issue.Status != IssueStatus.ResolvedInFuture)
                    {
                        <li><button @onclick="() => UpdateStatus(IssueStatus.ResolvedInFuture)" disabled="@_loading">Resolve in Next Release</button></li>
                    }
                    @if (Issue.Status != IssueStatus.Ignored)
                    {
                        <li><button @onclick="() => UpdateStatus(IssueStatus.Ignored)" disabled="@_loading">Ignore</button></li>
                        <li><button @onclick="() => UpdateStatusIgnoreFuture(IssueStatus.Ignored)" disabled="@_loading">Ignore + future events</button></li>
                    }
                </ul>
            </div>
            <!-- Priority row -->
            <div class="dropdown dropdown-end w-full">
                <label tabindex="0" class="btn btn-ghost btn-sm w-full justify-between rounded-b-2xl rounded-t-none px-4 h-11" aria-disabled="@_loading">
                    <span class="text-sm opacity-60">Priority</span>
                    <div class="flex items-center gap-1.5">
                        <span class="text-sm">@Issue.Priority</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </label>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-full shadow z-10 p-1">
                    @foreach (var p in Enum.GetValues<Priority>())
                    {
                        <li><button @onclick="() => SetPriority(p)" disabled="@_loading" class="@(p == Issue.Priority ? "active" : "")">@p</button></li>
                    }
                </ul>
            </div>
        </div>
    </div>

    <!-- Details -->
    <div class="card bg-base-200">
        <div class="card-body p-4 space-y-1 text-sm">
            <div class="flex justify-between">
                <span class="opacity-60">Severity</span>
                <SeverityBadge Level="Issue.Level" />
            </div>
            <div class="flex justify-between">
                <span class="opacity-60">Assigned</span>
                <span>@(Issue.AssignedToName ?? "Unassigned")</span>
            </div>
            <div class="flex flex-col whitespace-nowrap">
                <div class="flex justify-between">
                    <span class="opacity-60">First Seen</span>
                    <RelativeTime Value="Issue.FirstSeen"/>
                </div>
                @if (!string.IsNullOrEmpty(Issue.FirstRelease))
                {
                    <div class="text-xs text-end opacity-50 font-mono truncate">@TagValueFormatter.Format("release", Issue.FirstRelease)</div>
                }
            </div>
            <div class="flex flex-col whitespace-nowrap">
                <div class="flex justify-between">
                    <span class="opacity-60">Last Seen</span>
                    <RelativeTime Value="Issue.LastSeen"/>
                </div>
                @if (!string.IsNullOrEmpty(Issue.LastRelease))
                {
                    <div class="text-xs text-end opacity-50 font-mono truncate">@TagValueFormatter.Format("release", Issue.LastRelease)</div>
                }
            </div>
            <div class="flex justify-between">
                <span class="opacity-60">Events</span>
                <span class="font-mono">@Issue.OccurrenceCount</span>
            </div>
            @if (_histogram is not null && _histogram.Any(v => v > 0))
            {
                <div class="pt-1">
                    <div class="text-xs opacity-60 mb-1">Last 14 days</div>
                    <Sparkline Data="_histogram" Width="248" Height="32" Class="w-full text-primary" />
                </div>
            }
            @if (Issue.MergeSet is not null)
            {
                <div class="flex justify-between">
                    <span class="opacity-60">Merge Group</span>
                    <span class="font-mono">@Issue.MergeSet.Members.Count members</span>
                </div>
            }
        </div>
    </div>

    <!-- Tags with frequency bars -->
    @{
        var systemTags = Issue.Tags.Where(t => SystemTags.IsSystemTag(t.Key)).ToList();
        var userTags   = Issue.Tags.Where(t => !SystemTags.IsSystemTag(t.Key)).OrderBy(t => t.Key).ToList();
    }

    @if (systemTags.Count > 0)
    {
        <div class="card bg-base-200">
            <div class="card-body p-4 space-y-2">
                <span class="text-sm font-semibold">System Flags</span>
                <div class="flex flex-wrap gap-1">
                    @foreach (var tag in systemTags)
                    {
                        <span class="badge badge-sm badge-warning">@tag.Key[@SystemTags.Prefix.Length..]</span>
                    }
                </div>
            </div>
        </div>
    }

    @if (userTags.Count > 0)
    {
        <div class="card bg-base-200">
            <div class="card-body p-4 space-y-3">
                <span class="text-sm font-semibold">Tags</span>
                @foreach (var group in userTags)
                {
                    <div class="space-y-1">
                        <div class="text-xs font-semibold opacity-70">@group.Key</div>
                        @{
                            var topValues = group.Values.Take(4).ToList();
                            int othersCount = group.TotalCount - topValues.Sum(v => v.Count);
                        }
                        @foreach (var tagVal in topValues)
                        {
                            var pct = group.TotalCount > 0 ? (double)tagVal.Count / group.TotalCount * 100 : 0;
                            <div class="space-y-0.5">
                                <div class="flex justify-between text-xs">
                                    <span class="font-mono line-clamp-1" title="@tagVal.Value">
                                        <TagLink ProjectId="Issue.ProjectId" Key="@group.Key" Value="@tagVal.Value" />
                                    </span>
                                    <span class="opacity-50 shrink-0 ml-2">@pct.ToString("F0")%</span>
                                </div>
                                <div class="w-full bg-base-300 rounded-full h-1">
                                    <div class="bg-primary rounded-full h-1" style="width: @pct.ToString("F1")%"></div>
                                </div>
                            </div>
                        }
                        @if (othersCount > 0)
                        {
                            var othersPct = (double)othersCount / group.TotalCount * 100;
                            <div class="space-y-0.5">
                                <div class="flex justify-between text-xs">
                                    <span class="opacity-50 italic">others</span>
                                    <span class="opacity-50 shrink-0 ml-2">@othersPct.ToString("F0")%</span>
                                </div>
                                <div class="w-full bg-base-300 rounded-full h-1">
                                    <div class="bg-base-content/20 rounded-full h-1" style="width: @othersPct.ToString("F1")%"></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public IssueDetailResponse Issue { get; set; } = default!;
    [Parameter] public EventCallback<IssueStatus> OnStatusChanged { get; set; }
    [Parameter] public EventCallback<Priority> OnPriorityChanged { get; set; }

    private bool _loading;
    private List<int>? _histogram;

    protected override async Task OnParametersSetAsync()
    {
        try { _histogram = await IssueService.GetHistogramAsync(Issue.Id); }
        catch { _histogram = null; }
    }

    private async Task UpdateStatus(IssueStatus status)
    {
        _loading = true;
        try
        {
            await IssueService.UpdateIssueStatusAsync(Issue.Id, status);
            await OnStatusChanged.InvokeAsync(status);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdateStatusIgnoreFuture(IssueStatus status)
    {
        _loading = true;
        try
        {
            await IssueService.UpdateIssueStatusAsync(Issue.Id, status, ignoreFutureEvents: true);
            await OnStatusChanged.InvokeAsync(status);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SetPriority(Priority priority)
    {
        _loading = true;
        try
        {
            await IssueService.UpdateIssuePriorityAsync(Issue.Id, priority);
            await OnPriorityChanged.InvokeAsync(priority);
        }
        finally
        {
            _loading = false;
        }
    }
}
