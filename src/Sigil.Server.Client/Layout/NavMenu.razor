@using Sigil.Application.Models.Projects
@inject IServiceScopeFactory ScopeFactory

<div class="p-4 border-b border-base-300">
    <a href="/" class="text-xl font-bold">سجل</a>
</div>

<AuthorizeView>
    <Authorized>

        <ul class="menu flex-1 w-full">

            <li class="menu-title mt-4">Projects</li>
            @if (_projects is not null)
            {
                @foreach (var p in _projects)
                {
                    <li>
                        <NavLink href="@($"/projects/{p.Id}")" Match="NavLinkMatch.Prefix" class="menu-dropdown-toggle" ActiveClass="menu-dropdown-show">@p.Name</NavLink>
                        <ul class="menu-dropdown">
                            <li>
                                <NavLink href="@($"/projects/{p.Id}/issues")" Match="NavLinkMatch.Prefix" ActiveClass="menu-active">
                                    Issues
                                </NavLink>
                            </li>
                            <li>
                                <NavLink href="@($"/projects/{p.Id}/settings")" Match="NavLinkMatch.All" ActiveClass="menu-active">
                                    Settings
                                </NavLink>
                            </li>
                        </ul>
                    </li>
                }
            }
            <div class="flex-1"></div>

            <li class="menu-title mt-4">Organization</li>
            <li>
                <NavLink href="/teams" Match="NavLinkMatch.Prefix" ActiveClass="menu-active">
                    Teams
                </NavLink>
            </li>
            <li>
                <NavLink href="/projects/create" Match="NavLinkMatch.All" ActiveClass="menu-active">
                    Create Project
                </NavLink>
            </li>

            <li class="menu-title mt-4">Admin</li>
            <li>
                <NavLink href="/admin/users" Match="NavLinkMatch.Prefix" ActiveClass="menu-active">
                    Users
                </NavLink>
            </li>
            <li>
                <NavLink href="/admin/migrations" Match="NavLinkMatch.All" ActiveClass="menu-active">
                    Migrations
                </NavLink>
            </li>
            <li>
                <NavLink href="/admin/digestion" Match="NavLinkMatch.All" ActiveClass="menu-active">
                    Digestion
                </NavLink>
            </li>
        </ul>

        <form action="/logout" method="post" class="p-3 border-t border-base-300">
            <div class="text-sm opacity-70 mb-2">@context.User.Identity?.Name</div>
            <button type="submit" class="btn btn-ghost btn-sm w-full">Sign Out</button>
        </form>
    </Authorized>
</AuthorizeView>

@code {
    private List<ProjectResponse>? _projects;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var service = scope.ServiceProvider.GetRequiredService<IProjectService>();
            _projects = await service.GetProjectListAsync();
        }
        catch
        {
            // Not authenticated or server error
        }
    }
}
