@using Sigil.Application.Models.Projects
@inject IProjectService ProjectService
@inject IAuthService AuthService
@inject NavigationManager Navigation

<div class="p-4 border-b border-base-300">
    <a href="/" class="text-xl font-bold">Sigil</a>
</div>

<AuthorizeView>
    <Authorized>
        <!-- Project selector -->
        <div class="p-3">
            <select class="select select-bordered select-sm w-full" @onchange="OnProjectChanged">
                @if (projects is not null)
                {
                    @foreach (var p in projects)
                    {
                        <option value="@p.Id" selected="@(p.Id == selectedProjectId)">@p.Name</option>
                    }
                }
            </select>
        </div>

        <ul class="menu flex-1">
            @if (selectedProjectId > 0)
            {
                <li>
                    <NavLink href="@($"/projects/{selectedProjectId}/issues")" Match="NavLinkMatch.Prefix">
                        Issues
                    </NavLink>
                </li>
                <li>
                    <NavLink href="@($"/projects/{selectedProjectId}/settings")" Match="NavLinkMatch.All">
                        Settings
                    </NavLink>
                </li>
            }
        </ul>

        <div class="p-3 border-t border-base-300">
            <div class="text-sm opacity-70 mb-2">@context.User.Identity?.Name</div>
            <button class="btn btn-ghost btn-sm w-full" @onclick="Logout">Sign Out</button>
        </div>
    </Authorized>
</AuthorizeView>

@code {
    private List<ProjectResponse>? projects;
    private int selectedProjectId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            projects = await ProjectService.GetProjectListAsync();
            if (projects.Count > 0)
                selectedProjectId = projects[0].Id;
        }
        catch
        {
            // Not authenticated or server error
        }
    }

    private void OnProjectChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            selectedProjectId = id;
            Navigation.NavigateTo($"/projects/{id}/issues");
        }
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}
