@using Sigil.Application.Models.Projects
@inject IProjectService ProjectService

<div class="p-4 border-b border-base-300">
    <a href="/" class="text-xl font-bold">Sigil</a>
</div>

<AuthorizeView>
    <Authorized>


        <ul class="menu flex-1 w-full">
            <!-- Project selector -->
            @if (Projects is not null)
            {
                @foreach (var p in Projects)
                {
                    <li>
                        <NavLink href="@($"/projects/{p.Id}/issues")" Match="NavLinkMatch.Prefix" ActiveClass="menu-active">@p.Name</NavLink>
                    </li>
                }
            }
            <div class="divider"></div>
            @if (_projectId > 0)
            {
                <li>
                    <NavLink href="@($"/projects/{_projectId}/issues")" Match="NavLinkMatch.Prefix" ActiveClass="menu-active">
                        Issues
                    </NavLink>
                </li>
                <li>
                    <NavLink href="@($"/projects/{_projectId}/settings")" Match="NavLinkMatch.All" ActiveClass="menu-active">
                        Settings
                    </NavLink>
                </li>
            }

            <li class="menu-title mt-4">Organization</li>
            <li>
                <NavLink href="/teams" Match="NavLinkMatch.Prefix" ActiveClass="menu-active">
                    Teams
                </NavLink>
            </li>
            <li>
                <NavLink href="/projects/create" Match="NavLinkMatch.All" ActiveClass="menu-active">
                    Create Project
                </NavLink>
            </li>

            <li class="menu-title mt-4">Admin</li>
            <li>
                <NavLink href="/admin/users" Match="NavLinkMatch.Prefix" ActiveClass="menu-active">
                    Users
                </NavLink>
            </li>
        </ul>

        <form action="/logout" method="post" class="p-3 border-t border-base-300">
            <div class="text-sm opacity-70 mb-2">@context.User.Identity?.Name</div>
            <button type="submit" class="btn btn-ghost btn-sm w-full">Sign Out</button>
        </form>
    </Authorized>
</AuthorizeView>

@code {
    [PersistentState] public List<ProjectResponse>? Projects { get; set; }

    [CascadingParameter] public RouteData? RouteData { get; set; }

    private int _projectId;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Projects ??= await ProjectService.GetProjectListAsync();
        }
        catch
        {
            // Not authenticated or server error
        }
    }
    
    protected override void OnParametersSet()
    {
        if (RouteData?.RouteValues.TryGetValue("ProjectId", out var projectId) == true)
        {
            _projectId = int.TryParse(projectId?.ToString(), out int id) ? id : 0;
        }
    }
}
