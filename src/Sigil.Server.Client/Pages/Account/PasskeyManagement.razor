@page "/account/passkeys"
@implements IAsyncDisposable
@attribute [Authorize]
@using Sigil.Application.Models.Auth
@inject IPasskeyService PasskeyService
@inject IJSRuntime JS

<PageTitle>Passkeys â€” Sigil</PageTitle>

<div class="max-w-2xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-6">Passkey Management</h1>
    <p class="text-sm opacity-70 mb-6">
        Passkeys let you sign in with your fingerprint, face, or device PIN instead of a password.
        They work with Windows Hello, iCloud Keychain, Android, and password managers like Bitwarden.
    </p>

    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="alert @(_isError ? "alert-error" : "alert-success") mb-4">@_message</div>
    }

    <div class="card bg-base-200 mb-6">
        <div class="card-body">
            <h2 class="card-title text-lg">Register a new passkey</h2>
            <div class="flex gap-2 items-end">
                <fieldset class="fieldset flex-1">
                    <legend class="fieldset-legend">Passkey name</legend>
                    <input type="text" class="input w-full" placeholder="e.g. Laptop, Phone, Bitwarden"
                           @bind="_newPasskeyName" @bind:event="oninput"/>
                </fieldset>
                <button class="btn btn-primary mb-1" @onclick="RegisterPasskey" disabled="@(_registering || string.IsNullOrWhiteSpace(_newPasskeyName))">
                    @if (_registering)
                    {
                        <span class="loading loading-spinner loading-sm"></span>
                    }
                    Register
                </button>
            </div>
        </div>
    </div>

    <h2 class="text-lg font-semibold mb-3">Your passkeys</h2>

    @if (_loading)
    {
        <div class="flex justify-center p-8">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (_passkeys is null || _passkeys.Count == 0)
    {
        <div class="text-center py-8 opacity-60">
            No passkeys registered yet. Add one above to enable passwordless sign-in.
        </div>
    }
    else
    {
        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Created</th>
                        <th>Last Used</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pk in _passkeys)
                    {
                        <tr>
                            <td class="font-medium">@pk.DisplayName</td>
                            <td class="text-sm opacity-70">@pk.CreatedAt.ToLocalTime().ToString("MMM d, yyyy")</td>
                            <td class="text-sm opacity-70">@(pk.LastUsedAt?.ToLocalTime().ToString("MMM d, yyyy h:mm tt") ?? "Never")</td>
                            <td>
                                <button class="btn btn-ghost btn-sm text-error" @onclick="() => DeletePasskey(pk.Id)"
                                        disabled="@_deleting">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<PasskeyInfo>? _passkeys;
    private string _newPasskeyName = "";
    private string? _message;
    private bool _isError;
    private bool _loading = true;
    private bool _registering;
    private bool _deleting;
    private IJSObjectReference? _module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/webauthn.js");
            await LoadPasskeys();
        }
    }

    private async Task LoadPasskeys()
    {
        _loading = true;
        StateHasChanged();
        try
        {
            _passkeys = await PasskeyService.GetPasskeysAsync(Guid.Empty);
        }
        catch
        {
            _passkeys = [];
            ShowMessage("Failed to load passkeys.", true);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task RegisterPasskey()
    {
        if (string.IsNullOrWhiteSpace(_newPasskeyName) || _module is null) return;

        _registering = true;
        _message = null;
        StateHasChanged();

        try
        {
            var supported = await _module.InvokeAsync<bool>("isWebAuthnSupported");
            if (!supported)
            {
                ShowMessage("Passkeys are not supported by your browser.", true);
                return;
            }

            var options = await PasskeyService.GetRegistrationOptionsAsync(Guid.Empty);

            string attestationJson;
            try
            {
                attestationJson = await _module.InvokeAsync<string>("createCredential", options.OptionsJson);
            }
            catch (JSException)
            {
                ShowMessage("Passkey registration was cancelled.", true);
                return;
            }

            var result = await PasskeyService.CompleteRegistrationAsync(Guid.Empty, new PasskeyRegistrationResponse
            {
                AttestationResponseJson = attestationJson,
                DisplayName = _newPasskeyName.Trim()
            });

            if (result.Succeeded)
            {
                _newPasskeyName = "";
                ShowMessage("Passkey registered successfully!", false);
                await LoadPasskeys();
            }
            else
            {
                ShowMessage(result.Errors.FirstOrDefault() ?? "Registration failed.", true);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", true);
        }
        finally
        {
            _registering = false;
            StateHasChanged();
        }
    }

    private async Task DeletePasskey(int id)
    {
        _deleting = true;
        _message = null;
        StateHasChanged();

        try
        {
            var deleted = await PasskeyService.DeletePasskeyAsync(Guid.Empty, id);
            if (deleted)
            {
                ShowMessage("Passkey deleted.", false);
                await LoadPasskeys();
            }
            else
            {
                ShowMessage("Failed to delete passkey.", true);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", true);
        }
        finally
        {
            _deleting = false;
            StateHasChanged();
        }
    }

    private void ShowMessage(string message, bool isError)
    {
        _message = message;
        _isError = isError;
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }
    }
}
