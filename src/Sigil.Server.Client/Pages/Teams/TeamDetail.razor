@page "/teams/{TeamId:int}"
@attribute [Authorize]
@using Sigil.Application.Models.Auth
@using Sigil.Application.Models.Teams
@inject ITeamService TeamService
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Team â€” Sigil</PageTitle>

@if (loading)
{
    <div class="flex justify-center py-16">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
}
else if (Team is null)
{
    <EmptyState Title="Team not found" />
}
else
{
    <div class="max-w-4xl space-y-6">
        <!-- Team Name -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                @if (editingName)
                {
                    <div class="join">
                        <input type="text" class="input join-item" @bind="editName" />
                        <button class="btn join-item btn-primary" @onclick="SaveName" disabled="@saving">Save</button>
                        <button class="btn join-item" @onclick="() => editingName = false">Cancel</button>
                    </div>
                }
                else
                {
                    <h1 class="text-2xl font-bold">@Team.Name</h1>
                    <button class="btn btn-ghost btn-xs" @onclick="StartEditName">Edit</button>
                }
            </div>
            <button class="btn btn-error btn-sm" @onclick="DeleteTeam" disabled="@deleting">
                @(deleting ? "Deleting..." : "Delete Team")
            </button>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert alert-info text-sm">@message</div>
        }

        <TeamMembersCard TeamId="TeamId" Team="Team" AllUsers="AllUsers" OnChanged="LoadTeam" />

        <TeamProjectsCard TeamId="TeamId" Team="Team" />
    </div>
}

@code {
    [Parameter] public int TeamId { get; set; }

    [PersistentState] public TeamDetailResponse? Team { get; set; }
    [PersistentState] public List<UserInfo>? AllUsers { get; set; }
    private bool loading = true;
    private bool saving;
    private bool deleting;
    private bool editingName;
    private string editName = "";
    private string? message;

    protected override async Task OnParametersSetAsync()
    {
        if (Team is not null)
        {
            loading = false;
            return;
        }

        loading = true;
        await LoadTeam();
        loading = false;
    }

    private async Task LoadTeam()
    {
        try
        {
            Team = await TeamService.GetTeamDetailAsync(TeamId);
            AllUsers = await AuthService.GetAllUsersAsync();
        }
        catch
        {
            Team = null;
        }
    }

    private void StartEditName()
    {
        editName = Team?.Name ?? "";
        editingName = true;
    }

    private async Task SaveName()
    {
        if (string.IsNullOrWhiteSpace(editName)) return;
        saving = true;
        message = null;
        try
        {
            await TeamService.UpdateTeamAsync(TeamId, editName);
            await LoadTeam();
            editingName = false;
            message = "Team name updated.";
        }
        catch
        {
            message = "Failed to update team name.";
        }
        finally
        {
            saving = false;
        }
    }

    private async Task DeleteTeam()
    {
        deleting = true;
        try
        {
            await TeamService.DeleteTeamAsync(TeamId);
            Navigation.NavigateTo("/teams");
        }
        catch
        {
            message = "Failed to delete team.";
            deleting = false;
        }
    }
}
