@page "/setup"
@attribute [AllowAnonymous]
@using Sigil.Application.Models.Auth
@layout SetupLayout
@inject ISetupService SetupService
@inject NavigationManager Navigation

<PageTitle>Setup — Sigil</PageTitle>

<div class="min-h-screen flex items-center justify-center bg-base-300 p-4">
    <div class="card bg-base-100 shadow-xl w-full max-w-lg">
        <div class="card-body">
            <!-- Progress steps -->
            <ul class="steps steps-horizontal w-full mb-6 text-xs">
                <li class="step @(step >= 1 ? "step-primary" : "")">Welcome</li>
                <li class="step @(step >= 2 ? "step-primary" : "")">Database</li>
                <li class="step @(step >= 3 ? "step-primary" : "")">Config</li>
                <li class="step @(step >= 4 ? "step-primary" : "")">Admin</li>
                <li class="step @(step >= 5 ? "step-primary" : "")">Project</li>
                <li class="step @(step >= 6 ? "step-primary" : "")">Done</li>
            </ul>

            @if (step == 1)
            {
                <!-- Step 1: Welcome -->
                <div class="text-center space-y-4">
                    <h2 class="text-2xl font-bold">Welcome to Sigil سجل</h2>
                    <p class="opacity-70">Self-hosted error monitoring for your applications. Let's get you set up in a few steps.</p>
                    <button class="btn btn-primary" @onclick="() => GoTo(2)">Get Started</button>
                </div>
            }
            else if (step == 2)
            {
                <!-- Step 2: Database -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold">Database</h2>

                    @if (dbLoading)
                    {
                        <div class="flex items-center gap-2">
                            <span class="loading loading-spinner loading-sm"></span>
                            <span>Checking database connection...</span>
                        </div>
                    }
                    else if (dbStatus == DbConnectionStatus.ConnectionFailed)
                    {
                        <div class="alert alert-error">
                            <span>Cannot connect to the database server. Please check your connection string, credentials, and ensure PostgreSQL is running.</span>
                        </div>
                        @if (!string.IsNullOrEmpty(dbError))
                        {
                            <pre class="text-xs opacity-60 bg-base-200 p-2 rounded overflow-x-auto">@dbError</pre>
                        }
                        <button class="btn btn-outline btn-sm" @onclick="() => CheckDatabase(true)">Retry</button>
                    }
                    else if (dbStatus == DbConnectionStatus.DatabaseNotFound)
                    {
                        <div class="alert alert-warning">
                            <span>PostgreSQL server is reachable but the database does not exist yet. Apply migrations to create it.</span>
                        </div>
                        if (dbPending.Count > 0)
                        {
                            <div class="alert alert-info text-sm">
                                <span>This will create or update database tables. Make sure you have a backup if this is an existing database.</span>
                            </div>
                            <div class="bg-base-200 rounded p-3 text-sm space-y-1">
                                <div class="font-semibold mb-1">Pending migrations:</div>
                                @foreach (var m in dbPending)
                                {
                                    <div class="font-mono text-xs"> - @m</div>
                                }
                            </div>
                        }
                        <div class="flex gap-2">
                            <button class="btn btn-primary" @onclick="RunMigrations" disabled="@migrating">
                                @if (migrating)
                                {
                                    <span class="loading loading-spinner loading-sm"></span>
                                }
                                Create Database &amp; Apply Migrations
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(migrateError))
                        {
                            <div class="alert alert-error text-sm">@migrateError</div>
                        }
                    }
                    else if (dbPending.Count > 0)
                    {
                        <div class="alert alert-warning">
                            <span>Database connected but @dbPending.Count migration(s) need to be applied.</span>
                        </div>
                        <div class="alert alert-info text-sm">
                            <span>This will create or update database tables. Make sure you have a backup if this is an existing database.</span>
                        </div>
                        <div class="bg-base-200 rounded p-3 text-sm space-y-1">
                            <div class="font-semibold mb-1">Pending migrations:</div>
                            @foreach (var m in dbPending)
                            {
                                <div class="font-mono text-xs"> - @m</div>
                            }
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" @onclick="RunMigrations" disabled="@migrating">
                                @if (migrating)
                                {
                                    <span class="loading loading-spinner loading-sm"></span>
                                }
                                Apply Migrations
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(migrateError))
                        {
                            <div class="alert alert-error text-sm">@migrateError</div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-success">
                            <span>Database connected and up to date. @dbApplied.Count migration(s) applied.</span>
                        </div>
                        <div class="flex justify-end">
                            <button class="btn btn-primary" @onclick="() => GoTo(3)">Next</button>
                        </div>
                    }
                </div>
            }
            else if (step == 3)
            {
                <!-- Step 3: Config -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold">Configuration</h2>
                    <p class="text-sm opacity-70">Set the public URL where Sigil will be accessible. This is used to generate DSN strings for your SDKs.</p>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Host URL</legend>
                        <input type="url" class="input w-full" placeholder="https://sigil.example.com" @bind="hostUrl" />
                    </fieldset>

                    <div class="flex justify-between">
                        <button class="btn btn-ghost" @onclick="() => GoTo(2)">Back</button>
                        <button class="btn btn-primary" @onclick="() => GoTo(4)">Next</button>
                    </div>
                </div>
            }
            else if (step == 4)
            {
                <!-- Step 4: Admin -->
                <form class="space-y-4" @onsubmit="ValidateAdmin">
                    <h2 class="text-xl font-bold">Create Admin Account</h2>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Display Name</legend>
                        <input type="text" class="input w-full" placeholder="Admin" @bind="adminDisplayName" />
                    </fieldset>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Email</legend>
                        <input type="email" class="input w-full" placeholder="admin@example.com" @bind="adminEmail" />
                    </fieldset>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Password</legend>
                        <input type="password" class="input w-full" placeholder="Min 8 chars, uppercase, digit, special" @bind="adminPassword" />
                    </fieldset>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Confirm Password</legend>
                        <input type="password" class="input w-full" placeholder="Repeat Password" @bind="adminPasswordConfirm" />
                    </fieldset>

                    @if (!string.IsNullOrEmpty(adminError))
                    {
                        <div class="alert alert-error text-sm">@adminError</div>
                    }

                    <div class="flex justify-between">
                        <button class="btn btn-ghost" type="reset" @onclick="() => GoTo(3)">Back</button>
                        <button class="btn btn-primary" type="submit">Next</button>
                    </div>
                </form>
            }
            else if (step == 5)
            {
                <!-- Step 5: Project -->
                <form class="space-y-4" @onsubmit="RunSetup">
                    <h2 class="text-xl font-bold">Create Team & Project</h2>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Team Name</legend>
                        <input type="text" class="input w-full" @bind="teamName" />
                    </fieldset>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Project Name</legend>
                        <input type="text" class="input w-full" placeholder="My App" @bind="projectName" />
                    </fieldset>

                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Platform</legend>
                        <select class="select w-full" @bind="projectPlatform">
                            @foreach (Platform p in Enum.GetValues<Platform>())
                            {
                                <option value="@p">@p</option>
                            }
                        </select>
                    </fieldset>

                    @if (setupErrors.Count > 0)
                    {
                        <div class="alert alert-error text-sm">
                            <ul class="list-disc list-inside">
                                @foreach (var err in setupErrors)
                                {
                                    <li>@err</li>
                                }
                            </ul>
                        </div>
                    }

                    <div class="flex justify-between">
                        <button class="btn btn-ghost" type="reset" @onclick="() => GoTo(4)">Back</button>
                        <button class="btn btn-primary" type="submit" disabled="@initializing">
                            @if (initializing)
                            {
                                <span class="loading loading-spinner loading-sm"></span>
                            }
                            Create
                        </button>
                    </div>
                </form>
            }
            else if (step == 6)
            {
                <!-- Step 6: Done -->
                <div class="space-y-4">
                    <div class="text-center">
                        <h2 class="text-xl font-bold">You're all set!</h2>
                        <p class="opacity-70 mt-1">Sigil is ready to receive events.</p>
                    </div>

                    @if (!string.IsNullOrEmpty(dsn))
                    {
                        <fieldset class="fieldset">
                            <legend class="fieldset-legend">Your DSN</legend>
                            <div class="join w-full">
                                <input type="text" class="input join-item flex-1 font-mono text-sm" value="@dsn" readonly />
                                <CopyButton Text="@dsn" Class="btn join-item" />
                            </div>
                            <p class="label">Use this in your Sentry SDK configuration</p>
                        </fieldset>

                        <div class="collapse collapse-arrow bg-base-200">
                            <input type="checkbox" />
                            <div class="collapse-title font-medium text-sm">SDK Integration Examples</div>
                            <div class="collapse-content space-y-3 text-sm">
                                <div>
                                    <div class="font-semibold opacity-70">C# / .NET</div>
                                    <pre class="bg-base-300 p-2 rounded text-xs overflow-x-auto"><code>SentrySdk.Init(o =&gt; o.Dsn = "@dsn");</code></pre>
                                </div>
                                <div>
                                    <div class="font-semibold opacity-70">JavaScript</div>
                                    <pre class="bg-base-300 p-2 rounded text-xs overflow-x-auto"><code>Sentry.init({ dsn: "@dsn" });</code></pre>
                                </div>
                                <div>
                                    <div class="font-semibold opacity-70">Python</div>
                                    <pre class="bg-base-300 p-2 rounded text-xs overflow-x-auto"><code>sentry_sdk.init(dsn="@dsn")</code></pre>
                                </div>
                                <div>
                                    <div class="font-semibold opacity-70">Java</div>
                                    <pre class="bg-base-300 p-2 rounded text-xs overflow-x-auto"><code>Sentry.init(options -&gt; options.setDsn("@dsn"));</code></pre>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="flex justify-center">
                        <button class="btn btn-primary" @onclick="GoToDashboard">Go to Dashboard</button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "step")] public int StepParam { get; set; } = 1;

    private int step = 1;
    private bool _initialized;

    // Step 2: Database
    [PersistentState] public DbStatusResponse? DbSetupResponse { get; set; }
    private bool dbLoading = true;
    private DbConnectionStatus dbStatus = DbConnectionStatus.ConnectionFailed;
    private string? dbError;
    private IReadOnlyList<string> dbPending = [];
    private IReadOnlyList<string> dbApplied = [];
    private bool migrating;
    private string? migrateError;

    // Step 3: Config
    private string hostUrl = "";

    // Step 4: Admin
    private string adminDisplayName = "";
    private string adminEmail = "";
    private string adminPassword = "";
    private string adminPasswordConfirm = "";
    private string? adminError;

    // Step 5: Project
    private string teamName = "Default Team";
    private string projectName = "";
    private Platform projectPlatform = Platform.CSharp;
    private bool initializing;
    private List<string> setupErrors = [];

    // Step 6: Done
    private string? dsn;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            SetupStatus status = await SetupService.GetSetupStatusAsync();
            if (status.IsComplete)
            {
                step = 6;
                return;
            }

            hostUrl = Navigation.BaseUri.TrimEnd('/');
        }
        catch { }

        step = StepParam >= 1 && StepParam <= 6 ? StepParam : 1;
        _initialized = true;
        await CheckDatabase(false);
    }

    protected override void OnParametersSet()
    {
        if (_initialized && StepParam >= 1 && StepParam <= 6)
            step = StepParam;
    }

    private void GoTo(int target)
    {
        Navigation.NavigateTo($"/setup?step={target}");
        if (target == 2 && !dbLoading && dbStatus != DbConnectionStatus.Connected)
            _ = CheckDatabase(true);
    }

    private void GoToDashboard() => Navigation.NavigateTo("/", forceLoad: true);

    private async Task CheckDatabase(bool force)
    {
        dbLoading = true;
        dbError = null;
        StateHasChanged();

        try
        {
            if(DbSetupResponse == null || force)
                DbSetupResponse = await SetupService.GetDbStatusAsync();
            
            dbStatus = DbSetupResponse.Status;
            dbError = DbSetupResponse.Error;
            dbPending = DbSetupResponse.Pending;
            dbApplied = DbSetupResponse.Applied;
        }
        catch (Exception ex)
        {
            dbStatus = DbConnectionStatus.ConnectionFailed;
            dbError = ex.Message;
        }
        finally
        {
            dbLoading = false;
        }
        
        StateHasChanged();
    }

    private async Task RunMigrations()
    {
        migrating = true;
        migrateError = null;
        StateHasChanged();

        try
        {
            var success = await SetupService.MigrateAsync();
            if (success)
            {
                await CheckDatabase(true);
            }
            else
            {
                migrateError = "Migration failed. Setup may already be complete.";
            }
        }
        catch (Exception ex)
        {
            migrateError = ex.Message;
        }
        finally
        {
            migrating = false;
        }
    }

    private void ValidateAdmin()
    {
        adminError = null;

        if (string.IsNullOrWhiteSpace(adminDisplayName))
        {
            adminError = "Display name is required.";
            return;
        }
        if (string.IsNullOrWhiteSpace(adminEmail) || !adminEmail.Contains('@'))
        {
            adminError = "A valid email is required.";
            return;
        }
        if (adminPassword.Length < 8)
        {
            adminError = "Password must be at least 8 characters.";
            return;
        }
        if (!adminPassword.Any(char.IsUpper))
        {
            adminError = "Password must contain at least one uppercase letter.";
            return;
        }
        if (!adminPassword.Any(char.IsLower))
        {
            adminError = "Password must contain at least one lowercase letter.";
            return;
        }
        if (!adminPassword.Any(char.IsDigit))
        {
            adminError = "Password must contain at least one digit.";
            return;
        }
        if (!adminPassword.Any(c => !char.IsLetterOrDigit(c)))
        {
            adminError = "Password must contain at least one special character.";
            return;
        }
        if (adminPassword != adminPasswordConfirm)
        {
            adminError = "Passwords do not match.";
            return;
        }

        GoTo(5);
    }

    private async Task RunSetup()
    {
        setupErrors.Clear();

        if (string.IsNullOrWhiteSpace(projectName))
        {
            setupErrors.Add("Project name is required.");
            return;
        }

        initializing = true;
        StateHasChanged();

        try
        {
            var host = string.IsNullOrWhiteSpace(hostUrl) ? null : hostUrl.TrimEnd('/');

            var request = new SetupRequest(
                adminEmail, adminPassword, adminDisplayName,
                teamName, projectName, projectPlatform, host);

            var result = await SetupService.InitializeAsync(request);
            if (result.Succeeded)
            {
                var baseUrl = host ?? Navigation.BaseUri.TrimEnd('/');
                var uri = new Uri(baseUrl);
                dsn = $"{uri.Scheme}://{result.ProjectApiKey}@{uri.Authority}/{result.ProjectId}";
                step = 6;
            }
            else
            {
                setupErrors.AddRange(result.Errors);
            }
        }
        catch (Exception ex)
        {
            setupErrors.Add(ex.Message);
        }
        finally
        {
            initializing = false;
        }
    }


}
