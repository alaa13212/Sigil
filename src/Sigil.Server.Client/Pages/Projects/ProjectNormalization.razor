@page "/projects/{ProjectId:int}/settings/normalization"
@attribute [Authorize]
@using Sigil.Application.Models.NormalizationRules
@using Sigil.Domain.Entities
@using Sigil.Domain.Interfaces
@inject INormalizationRuleService NormalizationService
@inject IMessageNormalizer MessageNormalizer

@layout ProjectSettingsLayout

<PageTitle>Message Normalization — Sigil</PageTitle>

<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-bold">Message Normalization Rules</h2>
            <p class="text-sm opacity-60 mt-1">Custom rules are applied after the built-in defaults (UUIDs, numbers, emails, etc.). Higher priority number = applied first.</p>
        </div>
        <button class="btn btn-primary btn-sm" @onclick="() => { _editingRule = null; _modalOpen = true; }">
            Add Rule
        </button>
    </div>

    <!-- Preview -->
    <div class="card bg-base-200">
        <div class="card-body p-5 space-y-3">
            <h2 class="font-semibold">Test Normalization</h2>
            <p class="text-sm opacity-60">Enter a message to see how it looks after all normalization rules are applied.</p>
            <div class="flex gap-2">
                <input type="text" class="input input-sm flex-1 font-mono"
                       placeholder="e.g. Failed to process order-12345 for user abc@example.com"
                       @bind="previewInput" />
                <button class="btn btn-ghost btn-sm" @onclick="RunPreview">Preview</button>
            </div>
            @if (previewResult is not null)
            {
                <div class="bg-base-300 rounded p-3 font-mono text-sm break-all">
                    @previewResult
                </div>
            }
        </div>
    </div>

    @if (loading)
    {
        <div class="flex justify-center py-8">
            <span class="loading loading-spinner"></span>
        </div>
    }
    else if (rules.Count == 0)
    {
        <EmptyState Title="No custom rules" Description="Add a rule to normalize project-specific patterns like order IDs, user tokens, or internal codes." />
    }
    else
    {
        <div class="card bg-base-200">
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Pattern</th>
                            <th>Replacement</th>
                            <th>Priority</th>
                            <th>Enabled</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var rule in rules)
                        {
                            <tr>
                                <td class="opacity-70">@(rule.Description ?? "—")</td>
                                <td class="font-mono text-xs" title="@rule.Pattern">@TruncateValue(rule.Pattern)</td>
                                <td class="font-mono text-xs">@rule.Replacement</td>
                                <td class="text-sm">@rule.Priority</td>
                                <td>
                                    <input type="checkbox" class="toggle toggle-sm"
                                           checked="@rule.Enabled"
                                           @onchange="() => ToggleEnabled(rule)" />
                                </td>
                                <td class="flex gap-1">
                                    <button class="btn btn-ghost btn-xs"
                                            @onclick="() => { _editingRule = rule; _modalOpen = true; }">
                                        Edit
                                    </button>
                                    <button class="btn btn-ghost btn-xs text-error"
                                            @onclick="() => DeleteRule(rule.Id)">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<NormalizationRuleFormModal IsOpen="_modalOpen" ProjectId="ProjectId"
                             EditingRule="_editingRule" AllRules="rules"
                             OnSaved="OnSaved" OnClosed="() => _modalOpen = false" />

@code {
    [Parameter] public int ProjectId { get; set; }

    private List<TextNormalizationRule> rules = [];
    private bool loading = true;
    private string previewInput = "";
    private string? previewResult;
    private bool _modalOpen;
    private TextNormalizationRule? _editingRule;

    protected override async Task OnParametersSetAsync()
    {
        loading = true;
        try { rules = await NormalizationService.GetRulesAsync(ProjectId); }
        catch { rules = []; }
        loading = false;
    }

    private void OnSaved(TextNormalizationRule saved)
    {
        var idx = rules.FindIndex(r => r.Id == saved.Id);
        if (idx >= 0) rules[idx] = saved;
        else rules.Add(saved);
        rules.Sort((a, b) => b.Priority - a.Priority);
        _modalOpen = false;
    }

    private void RunPreview()
    {
        previewResult = MessageNormalizer.NormalizeMessage(rules, previewInput);
    }

    private async Task ToggleEnabled(TextNormalizationRule rule)
    {
        try
        {
            var req = new UpdateNormalizationRuleRequest(rule.Pattern, rule.Replacement, rule.Priority, !rule.Enabled, rule.Description);
            var updated = await NormalizationService.UpdateRuleAsync(rule.Id, req);
            if (updated is not null)
            {
                var idx = rules.IndexOf(rule);
                if (idx >= 0) rules[idx] = updated;
            }
        }
        catch { /* keep current state */ }
    }

    private async Task DeleteRule(int ruleId)
    {
        try
        {
            if (await NormalizationService.DeleteRuleAsync(ruleId))
                rules.RemoveAll(r => r.Id == ruleId);
        }
        catch { /* ignore */ }
    }

    private static string TruncateValue(string value) =>
        value.Length > 40 ? value[..37] + "…" : value;
}
