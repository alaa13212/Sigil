@page "/projects/{ProjectId:int}/settings"
@attribute [Authorize]
@using Sigil.Application.Models.Projects
@using Sigil.Application.Services
@inject IProjectService ProjectService
@inject NavigationManager NavigationManager
@inject PlatformInfoProvider PlatformInfoProvider

@layout ProjectSettingsLayout

<PageTitle>Project Settings — Sigil</PageTitle>

@if (loading)
{
    <div class="flex justify-center py-16">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
}
else if (Project is null)
{
    <EmptyState Title="Project not found" />
}
else
{
    <div class="max-w-2xl space-y-6">
        <h2 class="text-lg font-bold">General Settings</h2>
        
        <!-- Project Name -->
        <div class="card bg-base-100">
            <div class="card-body p-5 space-y-3">
                <h2 class="font-semibold">General</h2>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Project Name</legend>
                    <div class="join w-full">
                        <input type="text" class="input join-item flex-1" @bind="editName" />
                        <button class="btn join-item" @onclick="SaveName" disabled="@saving">
                            @(saving ? "Saving..." : "Save")
                        </button>
                    </div>
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Platform</legend>
                    <input type="text" class="input" value="@Project.Platform" disabled />
                </fieldset>
            </div>
        </div>

        <!-- API Key & DSN -->
        <div class="card bg-base-100">
            <div class="card-body p-5 space-y-3">
                <h2 class="font-semibold">Integration</h2>

                <fieldset class="fieldset">
                    <legend class="fieldset-legend">API Key</legend>
                    <div class="join w-full">
                        <input type="text" class="input join-item flex-1 font-mono text-sm"
                               value="@Project.ApiKey" readonly />
                        <CopyButton Text="@Project.ApiKey" Class="btn join-item btn-ghost" />
                    </div>
                </fieldset>

                @if (!string.IsNullOrEmpty(Project.Dsn))
                {
                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">DSN</legend>
                        <div class="join w-full">
                            <input type="text" class="input join-item flex-1 font-mono text-sm"
                                   value="@Project.Dsn" readonly />
                            <CopyButton Text="@Project.Dsn" Class="btn join-item btn-ghost" />
                        </div>
                    </fieldset>
                }

                <div class="divider"></div>

                <div>
                    <button class="btn btn-warning btn-sm" @onclick="RotateKey" disabled="@rotating">
                        @(rotating ? "Rotating..." : "Rotate API Key")
                    </button>
                    <p class="text-xs opacity-60 mt-1">This will invalidate the current key. Update your SDK configuration after rotating.</p>
                </div>

                @if (!string.IsNullOrEmpty(actionMessage))
                {
                    <div class="alert alert-info text-sm">@actionMessage</div>
                }
            </div>
        </div>

        <!-- SDK Setup -->
        @{
            var platformInfo = PlatformInfoProvider.GetInfo(Project.Platform);
        }
        <div class="card bg-base-100">
            <div class="card-body p-5 space-y-3">
                <h2 class="font-semibold">SDK Integration</h2>
                @if (platformInfo is not null)
                {
                    <div class="space-y-3 text-sm">
                        <div>
                            <div class="font-semibold opacity-70">Install (@platformInfo.SdkPackage)</div>
                            <pre class="bg-base-300 p-2 rounded text-xs overflow-x-auto"><code>@platformInfo.InstallCommand</code></pre>
                        </div>
                        <div>
                            <div class="font-semibold opacity-70">Initialize (@platformInfo.DisplayName)</div>
                            <pre class="bg-base-300 p-2 rounded text-xs overflow-x-auto"><code>@PlatformInfoProvider.FormatSnippet(Project.Platform, Project.Dsn ?? "")</code></pre>
                        </div>
                        @if (platformInfo.DocumentationUrl is not null)
                        {
                            <a href="@platformInfo.DocumentationUrl" target="_blank" class="link link-hover text-sm">
                                Full documentation →
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-sm opacity-70">Use the DSN above in your Sentry-compatible SDK configuration.</p>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ProjectId { get; set; }

    [PersistentState] public ProjectDetailResponse? Project { get; set; }
    private string editName = "";
    private bool loading = true;
    private bool saving;
    private bool rotating;
    private string? actionMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (Project is not null)
        {
            // Restored from persistent state after SSR prerender — skip the fetch
            editName = Project.Name;
            loading = false;
            return;
        }

        loading = true;
        await LoadProject();
        loading = false;
    }

    private async Task LoadProject()
    {
        try
        {
            Project = await ProjectService.GetProjectDetailAsync(ProjectId);
            if (Project is not null)
                editName = Project.Name;
        }
        catch
        {
            Project = null;
        }
    }

    private async Task SaveName()
    {
        if (string.IsNullOrWhiteSpace(editName)) return;

        saving = true;
        actionMessage = null;
        try
        {
            await ProjectService.UpdateProjectAsync(ProjectId, editName);
            await LoadProject();
            actionMessage = "Project name updated.";
            StateHasChanged();
            
            await Task.Delay(1000);
            NavigationManager.Refresh(true);
        }
        catch
        {
            actionMessage = "Failed to update project name.";
        }
        finally
        {
            saving = false;
        }
    }

    private async Task RotateKey()
    {
        rotating = true;
        actionMessage = null;
        try
        {
            await ProjectService.RotateApiKeyAsync(ProjectId);
            await LoadProject();
            actionMessage = "API key rotated successfully. Update your SDK configuration.";
        }
        catch
        {
            actionMessage = "Failed to rotate API key.";
        }
        finally
        {
            rotating = false;
        }
    }


}
