@page "/admin/users"
@attribute [Authorize]
@using Sigil.Application.Models.Auth
@inject IAuthService AuthService

<PageTitle>Users — Sigil</PageTitle>

<div class="max-w-4xl space-y-6 mx-auto">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Users</h1>
        <button class="btn btn-primary btn-sm" @onclick="() => showRegister = !showRegister">
            @(showRegister ? "Cancel" : "Register User")
        </button>
    </div>

    @if (showRegister)
    {
        <div class="card bg-base-200">
            <div class="card-body p-5 space-y-3">
                <h2 class="font-semibold">Register New User</h2>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Email</legend>
                    <input type="email" class="input w-full" @bind="regEmail" placeholder="user@example.com" />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Display Name</legend>
                    <input type="text" class="input w-full" @bind="regDisplayName" placeholder="John Doe" />
                </fieldset>
                <fieldset class="fieldset">
                    <legend class="fieldset-legend">Password</legend>
                    <input type="password" class="input w-full" @bind="regPassword" />
                </fieldset>
                @if (!string.IsNullOrEmpty(regError))
                {
                    <div class="alert alert-error text-sm">@regError</div>
                }
                @if (!string.IsNullOrEmpty(regSuccess))
                {
                    <div class="alert alert-success text-sm">@regSuccess</div>
                }
                <button class="btn btn-primary" @onclick="RegisterUser" disabled="@registering">
                    @(registering ? "Registering..." : "Register")
                </button>
            </div>
        </div>
    }

    @if (loading)
    {
        <div class="flex justify-center py-16">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (users is null || users.Count == 0)
    {
        <EmptyState Title="No users found" />
    }
    else
    {
        <div class="card bg-base-200">
            <div class="card-body p-0">
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Display Name</th>
                                <th>Email</th>
                                <th>Created</th>
                                <th>Last Login</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in users)
                            {
                                <tr>
                                    <td>@(user.DisplayName ?? "—")</td>
                                    <td>@user.Email</td>
                                    <td>@user.CreatedAt.ToString("yyyy-MM-dd")</td>
                                    <td>@(user.LastLogin?.ToString("yyyy-MM-dd HH:mm") ?? "Never")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<UserInfo>? users;
    private bool loading = true;
    private bool showRegister;
    private bool registering;
    private string regEmail = "";
    private string regDisplayName = "";
    private string regPassword = "";
    private string? regError;
    private string? regSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        loading = true;
        try
        {
            users = await AuthService.GetAllUsersAsync();
        }
        catch
        {
            users = null;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task RegisterUser()
    {
        if (string.IsNullOrWhiteSpace(regEmail) || string.IsNullOrWhiteSpace(regPassword))
        {
            regError = "Email and password are required.";
            return;
        }

        registering = true;
        regError = null;
        regSuccess = null;
        try
        {
            var result = await AuthService.RegisterAsync(new RegisterRequest(regEmail, regPassword, regDisplayName));
            if (result.Succeeded)
            {
                regSuccess = $"User {regEmail} registered successfully.";
                regEmail = "";
                regDisplayName = "";
                regPassword = "";
                await LoadUsers();
            }
            else
            {
                regError = string.Join(", ", result.Errors);
            }
        }
        catch
        {
            regError = "Failed to register user.";
        }
        finally
        {
            registering = false;
        }
    }
}
