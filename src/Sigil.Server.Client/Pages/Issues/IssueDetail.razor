@page "/projects/{ProjectId:int}/issues/{IssueId:int}"
@attribute [Authorize]
@using Sigil.Application.Models.Issues
@using Sigil.Application.Models.Events
@inject IIssueService IssueService
@inject IEventService EventService
@inject IIssueActivityService ActivityService
@rendermode InteractiveWebAssembly

<PageTitle>@(issue?.Title ?? "Issue") — Sigil</PageTitle>

@if (loading)
{
    <div class="flex justify-center py-16">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
}
else if (issue is null)
{
    <EmptyState Title="Issue not found" Description="This issue may have been deleted." />
}
else
{
    <PageBreadcrumb Items="@([ new PageBreadcrumb.BreadcrumbItem("Projects", "/"), new PageBreadcrumb.BreadcrumbItem("Issues", $"/projects/{issue.ProjectId}/issues"), new PageBreadcrumb.BreadcrumbItem(issue.Title) ])" />

    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left column: main content -->
        <div class="flex-1 min-w-0 space-y-4">
            <!-- Title and exception type -->
            <div>
                <h1 class="text-2xl font-bold break-words">@issue.Title</h1>
                @if (!string.IsNullOrEmpty(issue.ExceptionType))
                {
                    <div class="text-sm opacity-60 mt-1 font-mono">@issue.ExceptionType</div>
                }
                @if (!string.IsNullOrEmpty(issue.Culprit))
                {
                    <div class="text-sm opacity-50 mt-1">@issue.Culprit</div>
                }
            </div>

            <!-- Tabs -->
            <div role="tablist" class="tabs tabs-bordered">
                @if (issue.SuggestedEvent is not null && eventDetail is not null)
                {
                    <a role="tab" href="/projects/@ProjectId/issues/@IssueId?tab=event"
                       class="tab @(activeTab == Tab.SuggestedEvent ? "tab-active" : "")">Event</a>
                }
                <a role="tab" href="/projects/@ProjectId/issues/@IssueId?tab=events"
                   class="tab @(activeTab == Tab.Events ? "tab-active" : "")">Events</a>
                <a role="tab" href="/projects/@ProjectId/issues/@IssueId?tab=activity"
                   class="tab @(activeTab == Tab.Activity ? "tab-active" : "")">Activity</a>
            </div>

            <!-- Suggested Event tab -->
            @if (activeTab == Tab.SuggestedEvent && eventDetail is not null)
            {
                <div class="space-y-4">
                    <!-- Navigation bar: Prev/Next + View full event -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <button class="btn btn-ghost btn-sm" disabled="@(navigation?.PreviousEventId is null || eventNavigating)"
                                    @onclick="() => NavigateEvent(navigation!.PreviousEventId!.Value)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                                Older
                            </button>
                            <button class="btn btn-ghost btn-sm" disabled="@(navigation?.NextEventId is null || eventNavigating)"
                                    @onclick="() => NavigateEvent(navigation!.NextEventId!.Value)">
                                Newer
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                        <a href="/projects/@ProjectId/issues/@IssueId/events/@eventDetail.Id" class="btn btn-ghost btn-sm">
                            View full event
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                        </a>
                    </div>

                    <div class="flex items-center gap-3 text-sm opacity-60">
                        <SeverityBadge Level="eventDetail.Level" />
                        <RelativeTime Value="eventDetail.Timestamp" />
                        <span>·</span>
                        <span>@eventDetail.Timestamp.ToString("yyyy-MM-dd HH:mm:ss UTC")</span>
                    </div>

                    @if (!string.IsNullOrEmpty(eventDetail.Message))
                    {
                        <div class="alert">
                            <span class="font-mono text-sm break-words">@eventDetail.Message</span>
                        </div>
                    }

                    @if (eventDetail.StackFrames.Count > 0)
                    {
                        <div class="card bg-base-200">
                            <div class="card-body p-4 overflow-auto">
                                <h2 class="card-title text-base">Stack Trace</h2>
                                <StackTraceViewer Frames="eventDetail.StackFrames" />
                            </div>
                        </div>
                    }

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h2 class="card-title text-base">Context</h2>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="opacity-60">Platform</span>
                                        <span>@eventDetail.Platform</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(eventDetail.Release))
                                    {
                                        <div class="flex justify-between">
                                            <span class="opacity-60">Release</span>
                                            <span class="font-mono">@eventDetail.Release</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(eventDetail.Environment))
                                    {
                                        <div class="flex justify-between">
                                            <span class="opacity-60">Environment</span>
                                            <span>@eventDetail.Environment</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        @if (eventDetail.User is not null)
                        {
                            <div class="card bg-base-200">
                                <div class="card-body p-4">
                                    <h2 class="card-title text-base">User</h2>
                                    <div class="space-y-1 text-sm">
                                        @if (!string.IsNullOrEmpty(eventDetail.User.Username))
                                        {
                                            <div class="flex justify-between">
                                                <span class="opacity-60">Username</span>
                                                <span>@eventDetail.User.Username</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(eventDetail.User.Email))
                                        {
                                            <div class="flex justify-between">
                                                <span class="opacity-60">Email</span>
                                                <span>@eventDetail.User.Email</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(eventDetail.User.IpAddress))
                                        {
                                            <div class="flex justify-between">
                                                <span class="opacity-60">IP</span>
                                                <span class="font-mono">@eventDetail.User.IpAddress</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(eventDetail.User.Identifier))
                                        {
                                            <div class="flex justify-between">
                                                <span class="opacity-60">ID</span>
                                                <span class="font-mono">@eventDetail.User.Identifier</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @if (eventDetail.Tags.Count > 0)
                    {
                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h2 class="card-title text-base">Tags</h2>
                                <div class="overflow-x-auto">
                                    <table class="table table-sm">
                                        <tbody>
                                            @foreach (var tag in eventDetail.Tags.OrderBy(t => t.Key))
                                            {
                                                <tr>
                                                    <td class="opacity-60 w-1/3">@tag.Key</td>
                                                    <td class="font-mono">@tag.Value</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Breadcrumbs -->
                    @if (breadcrumbs.Count > 0)
                    {
                        <div class="card bg-base-200">
                            <div class="card-body p-4">
                                <h2 class="card-title text-base">Breadcrumbs</h2>
                                <BreadcrumbsViewer Breadcrumbs="breadcrumbs" EventTimestamp="eventDetail.Timestamp" />
                            </div>
                        </div>
                    }
                </div>
            }

            <!-- Events tab -->
            @if (activeTab == Tab.Events)
            {
                @if (events is null || events.Items.Count == 0)
                {
                    <EmptyState Title="No events" />
                }
                else
                {
                    <div class="overflow-x-auto">
                        <table class="table table-sebra table-sm">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Message</th>
                                    <th>Severity</th>
                                    <th>User</th>
                                    <th>Release</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evt in events.Items)
                                {
                                    <tr class="hover:bg-base-300 relative cursor-pointer">
                                        <td>
                                            <a href="/projects/@ProjectId/issues/@IssueId/events/@evt.Id" class="stretched-link"><RelativeTime Value="evt.Timestamp"/></a>
                                        </td>
                                        <td class="max-w-md truncate">@(evt.Message ?? "—")</td>
                                        <td><SeverityBadge Level="evt.Level" /></td>
                                        <td class="text-sm opacity-70">@(evt.UserIdentifier ?? "—")</td>
                                        <td class="text-sm font-mono opacity-70">@(evt.Release ?? "—")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <Pagination Page="eventsPage" TotalCount="events.TotalCount" PageSize="EventsPageSize"
                                OnPageChanged="OnEventsPageChanged" />
                }
            }

            <!-- Activity tab -->
            @if (activeTab == Tab.Activity)
            {
                @if (activities is null || activities.Items.Count == 0)
                {
                    <EmptyState Title="No activity yet" />
                }
                else
                {
                    <ul class="timeline timeline-vertical timeline-compact">
                        @foreach (var act in activities.Items)
                        {
                            <li>
                                <div class="timeline-start text-xs opacity-60">
                                    <RelativeTime Value="act.Timestamp" />
                                </div>
                                <div class="timeline-middle">
                                    <div class="w-2 h-2 rounded-full bg-base-content opacity-40"></div>
                                </div>
                                <div class="timeline-end text-sm pb-4">
                                    <span class="font-medium">@FormatAction(act.Action)</span>
                                    @if (!string.IsNullOrEmpty(act.UserName))
                                    {
                                        <span class="opacity-70"> by @act.UserName</span>
                                    }
                                    @if (!string.IsNullOrEmpty(act.Message))
                                    {
                                        <div class="text-xs opacity-60 mt-0.5">@act.Message</div>
                                    }
                                </div>
                            </li>
                        }
                    </ul>
                }
            }
        </div>

        <!-- Right sidebar -->
        <div class="w-full lg:w-72 space-y-4">
            <!-- Status actions -->
            <div class="card bg-base-200">
                <div class="card-body p-4 space-y-3">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-semibold">Status</span>
                        <StatusBadge Status="issue.Status" />
                    </div>
                    <div class="flex flex-wrap gap-1">
                        @if (issue.Status != IssueStatus.Resolved)
                        {
                            <button class="btn btn-success btn-sm" @onclick="() => UpdateStatus(IssueStatus.Resolved)" disabled="@actionLoading">
                                Resolve
                            </button>
                        }
                        @if (issue.Status != IssueStatus.Open)
                        {
                            <button class="btn btn-info btn-sm" @onclick="() => UpdateStatus(IssueStatus.Open)" disabled="@actionLoading">
                                Reopen
                            </button>
                        }
                        @if (issue.Status != IssueStatus.Ignored)
                        {
                            <button class="btn btn-ghost btn-sm" @onclick="() => UpdateStatus(IssueStatus.Ignored)" disabled="@actionLoading">
                                Ignore
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Priority -->
            <div class="card bg-base-200">
                <div class="card-body p-4">
                    <fieldset class="fieldset">
                        <legend class="fieldset-legend">Priority</legend>
                        <select class="select select-sm w-full" value="@issue.Priority"
                                @onchange="OnPriorityChanged" disabled="@actionLoading">
                            @foreach (var p in Enum.GetValues<Priority>())
                            {
                                <option value="@p">@p</option>
                            }
                        </select>
                    </fieldset>
                </div>
            </div>

            <!-- Details -->
            <div class="card bg-base-200">
                <div class="card-body p-4 space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="opacity-60">Severity</span>
                        <SeverityBadge Level="issue.Level" />
                    </div>
                    <div class="flex justify-between">
                        <span class="opacity-60">Assigned</span>
                        <span>@(issue.AssignedToName ?? "Unassigned")</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="opacity-60">First Seen</span>
                        <div class="text-right">
                            <RelativeTime Value="issue.FirstSeen" />
                            @if (!string.IsNullOrEmpty(issue.FirstRelease))
                            {
                                <div class="text-xs opacity-50 font-mono">@issue.FirstRelease</div>
                            }
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <span class="opacity-60">Last Seen</span>
                        <div class="text-right">
                            <RelativeTime Value="issue.LastSeen" />
                            @if (!string.IsNullOrEmpty(issue.LastRelease))
                            {
                                <div class="text-xs opacity-50 font-mono">@issue.LastRelease</div>
                            }
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <span class="opacity-60">Events</span>
                        <span class="font-mono">@issue.OccurrenceCount</span>
                    </div>
                </div>
            </div>

            <!-- Tags grouped with frequency -->
            @if (issue.Tags.Count > 0)
            {
                <div class="card bg-base-200">
                    <div class="card-body p-4 space-y-3">
                        <span class="text-sm font-semibold">Tags</span>
                        @foreach (var group in issue.Tags.OrderBy(t => t.Key))
                        {
                            <div class="space-y-1">
                                <div class="text-xs font-semibold opacity-70">@group.Key</div>
                                @{
                                    var topValues = group.Values.Take(4).ToList();
                                    int othersCount = group.TotalCount - topValues.Sum(v => v.Count);
                                }
                                @foreach (var tagVal in topValues)
                                {
                                    var pct = group.TotalCount > 0 ? (double)tagVal.Count / group.TotalCount * 100 : 0;
                                    <div class="space-y-0.5">
                                        <div class="flex justify-between text-xs">
                                            <span class="font-mono truncate max-w-[210px]" title="@tagVal.Value">@tagVal.Value</span>
                                            <span class="opacity-50 shrink-0 ml-2">@pct.ToString("F0")%</span>
                                        </div>
                                        <div class="w-full bg-base-300 rounded-full h-1">
                                            <div class="bg-primary rounded-full h-1" style="width: @pct.ToString("F1")%"></div>
                                        </div>
                                    </div>
                                }
                                @if (othersCount > 0)
                                {
                                    var othersPct = (double)othersCount / group.TotalCount * 100;
                                    <div class="space-y-0.5">
                                        <div class="flex justify-between text-xs">
                                            <span class="opacity-50 italic">others</span>
                                            <span class="opacity-50 shrink-0 ml-2">@othersPct.ToString("F0")%</span>
                                        </div>
                                        <div class="w-full bg-base-300 rounded-full h-1">
                                            <div class="bg-base-content/20 rounded-full h-1" style="width: @othersPct.ToString("F1")%"></div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public int ProjectId { get; set; }
    [Parameter] public int IssueId { get; set; }
    [SupplyParameterFromQuery(Name = "tab")] public string? TabParam { get; set; }

    private IssueDetailResponse? issue;
    private EventDetailResponse? eventDetail;
    private EventNavigationResponse? navigation;
    private List<BreadcrumbResponse> breadcrumbs = [];
    private PagedResponse<EventSummary>? events;
    private PagedResponse<ActivityResponse>? activities;
    private bool loading = true;
    private bool actionLoading;
    private bool eventNavigating;
    private Tab activeTab = Tab.Events;
    private int eventsPage = 1;
    private const int EventsPageSize = 50;

    private enum Tab { SuggestedEvent, Events, Activity }

    protected override async Task OnParametersSetAsync()
    {
        loading = true;
        events = null;
        activities = null;
        breadcrumbs = [];
        navigation = null;

        await LoadIssue();

        activeTab = TabParam?.ToLower() switch
        {
            "event"    => issue?.SuggestedEvent is not null ? Tab.SuggestedEvent : Tab.Events,
            "events"   => Tab.Events,
            "activity" => Tab.Activity,
            _          => issue?.SuggestedEvent is not null ? Tab.SuggestedEvent : Tab.Events
        };

        loading = false;

        if (activeTab == Tab.Events)
            await LoadEvents();
        else if (activeTab == Tab.Activity)
            await LoadActivity();
    }

    private async Task LoadIssue()
    {
        try
        {
            issue = await IssueService.GetIssueDetailAsync(IssueId);
            if (issue?.SuggestedEvent is not null)
            {
                eventDetail = await EventService.GetEventDetailAsync(issue.SuggestedEvent.Id);
                if (eventDetail is not null)
                {
                    navigation = await EventService.GetAdjacentEventIdsAsync(IssueId, eventDetail.Id);
                    breadcrumbs = await EventService.GetBreadcrumbsAsync(eventDetail.Id);
                }
            }
            else
            {
                eventDetail = null;
                navigation = null;
                breadcrumbs = [];
            }
        }
        catch
        {
            issue = null;
            eventDetail = null;
            navigation = null;
            breadcrumbs = [];
        }
    }

    private async Task NavigateEvent(long eventId)
    {
        eventNavigating = true;
        try
        {
            eventDetail = await EventService.GetEventDetailAsync(eventId);
            if (eventDetail is not null)
            {
                navigation = await EventService.GetAdjacentEventIdsAsync(IssueId, eventDetail.Id);
                breadcrumbs = await EventService.GetBreadcrumbsAsync(eventDetail.Id);
            }
        }
        catch
        {
            // Keep current event on navigation failure
        }
        finally
        {
            eventNavigating = false;
        }
    }

    private async Task LoadEvents()
    {
        try
        {
            events = await EventService.GetEventSummariesAsync(IssueId, eventsPage, EventsPageSize);
        }
        catch
        {
            events = null;
        }
    }

    private async Task LoadActivity()
    {
        try
        {
            activities = await ActivityService.GetActivitySummariesAsync(IssueId);
        }
        catch
        {
            activities = null;
        }
    }

    private async Task UpdateStatus(IssueStatus status)
    {
        actionLoading = true;
        try
        {
            await IssueService.UpdateIssueStatusAsync(IssueId, status);
            await LoadIssue();
        }
        finally
        {
            actionLoading = false;
        }
    }

    private async Task OnPriorityChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<Priority>(e.Value?.ToString(), out var priority))
        {
            actionLoading = true;
            try
            {
                await IssueService.UpdateIssuePriorityAsync(IssueId, priority);
                await LoadIssue();
            }
            finally
            {
                actionLoading = false;
            }
        }
    }

    private async Task OnEventsPageChanged(int newPage)
    {
        eventsPage = newPage;
        await LoadEvents();
    }

    private static string FormatAction(IssueActivityAction action) => action switch
    {
        IssueActivityAction.Created    => "Issue created",
        IssueActivityAction.Resolved   => "Resolved",
        IssueActivityAction.Unresolved => "Reopened",
        IssueActivityAction.Ignored    => "Ignored",
        IssueActivityAction.Assigned   => "Assigned",
        IssueActivityAction.Unassigned => "Unassigned",
        IssueActivityAction.Commented  => "Commented",
        _                              => action.ToString()
    };
}
