@page "/projects/{ProjectId:int}/issues/{IssueId:int}"
@attribute [Authorize]
@using Sigil.Application.Models.Issues
@using Sigil.Application.Models.Events
@inject IIssueService IssueService
@inject IBookmarkService BookmarkService
@inject IEventService EventService
@inject NavigationManager Navigation

<PageTitle>@(string.IsNullOrEmpty(issue?.Title) ? "Issue" : issue.Title) â€” Sigil</PageTitle>

@if (loading)
{
    <div class="flex justify-center py-16">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
}
else if (issue is null)
{
    <EmptyState Title="Issue not found" Description="This issue may have been deleted." />
}
else
{
    <PageBreadcrumb Items="@([ new PageBreadcrumb.BreadcrumbItem("Projects", "/"), new PageBreadcrumb.BreadcrumbItem("Issues", $"/projects/{issue.ProjectId}/issues"), new PageBreadcrumb.BreadcrumbItem(string.IsNullOrEmpty(issue.Title) ? "No message" : issue.Title) ])" />

    @if (issue.MergeSet is not null && issue.MergeSet.PrimaryIssueId != IssueId)
    {
        <div class="alert alert-info mb-4 flex flex-col items-start gap-0">
            <p>This issue is part of a <a href="/projects/@ProjectId/issues/@issue.MergeSet.PrimaryIssueId" class="link">merged group</a>.</p>
            <p>Viewing individual issue data.</p>
        </div>
    }

    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left column: main content -->
        <div class="flex-1 min-w-0 space-y-4">
            <!-- Title, exception type, culprit -->
            <div>
                <div class="flex items-start gap-2">
                    @if (!string.IsNullOrEmpty(issue.Title))
                    {
                        <h1 class="text-2xl font-bold break-words flex-1">@issue.Title</h1>
                    }
                    else
                    {
                        <h1 class="text-2xl font-bold break-words flex-1 opacity-50 italic">No message</h1>
                    }
                    <button class="btn btn-ghost btn-sm mt-0.5 shrink-0" @onclick="ToggleBookmark"
                            title="@(isBookmarked ? "Remove bookmark" : "Bookmark this issue")">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 @(isBookmarked ? "text-warning" : "opacity-40")"
                             fill="@(isBookmarked ? "currentColor" : "none")" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(issue.ExceptionType))
                {
                    <div class="text-sm opacity-60 mt-1 font-mono">@issue.ExceptionType</div>
                }
                @if (!string.IsNullOrEmpty(issue.Culprit))
                {
                    <div class="text-sm opacity-50 mt-1">@issue.Culprit</div>
                }
            </div>

            <!-- Tab bar -->
            <TabBar TTab="Tab" Tabs="_visibleTabs" ActiveTab="_activeTab" TabLabel="GetTabLabel" />

            <!-- Tab content -->
            @if (_activeTab == Tab.SuggestedEvent && eventDetail is not null)
            {
                <IssueEventPanel ProjectId="ProjectId" IssueId="IssueId"
                                 EventDetail="eventDetail" Navigation="navigation"
                                 Breadcrumbs="breadcrumbs" Navigating="eventNavigating"
                                 OnNavigateEvent="NavigateEvent" />
            }
            @if (_activeTab == Tab.Events)
            {
                <IssueEventsTab ProjectId="ProjectId" IssueId="IssueId" />
            }
            @if (_activeTab == Tab.Activity)
            {
                <IssueActivityTab IssueId="IssueId" />
            }
            @if (_activeTab == Tab.Similar)
            {
                <IssueSimilarTab ProjectId="ProjectId" IssueId="IssueId"
                                 MergeSet="issue.MergeSet" CurrentUserId="currentUserId"
                                 OnMergeChanged="LoadIssue" />
            }
        </div>

        <!-- Right sidebar -->
        <IssueSidebar Issue="issue" OnStatusChanged="OnIssueChanged" OnPriorityChanged="OnIssueChanged" />
    </div>
}

@code {
    [Parameter] public int ProjectId { get; set; }
    [Parameter] public int IssueId { get; set; }
    [SupplyParameterFromQuery(Name = "tab")] public string? TabParam { get; set; }
    [SupplyParameterFromQuery(Name = "no-redirect")] public bool NoRedirect { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = null!;

    private IssueDetailResponse? issue;
    private EventDetailResponse? eventDetail;
    private EventNavigationResponse? navigation;
    private List<BreadcrumbResponse> breadcrumbs = [];
    private bool loading = true;
    private bool eventNavigating;
    private Tab _activeTab = Tab.Events;
    private bool isBookmarked;
    private Guid currentUserId;

    private enum Tab { SuggestedEvent, Events, Activity, Similar }

    private static readonly Tab[] _allTabs = [Tab.SuggestedEvent, Tab.Events, Tab.Activity, Tab.Similar];
    private static readonly Tab[] _tabsWithoutEvent = [Tab.Events, Tab.Activity, Tab.Similar];

    private IReadOnlyList<Tab> _visibleTabs =>
        issue?.SuggestedEvent is not null && eventDetail is not null ? _allTabs : _tabsWithoutEvent;

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthState;
        var userIdStr = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        currentUserId = userIdStr is not null ? Guid.Parse(userIdStr) : Guid.Empty;

        loading = true;
        breadcrumbs = [];
        navigation = null;

        await LoadIssue();

        // Redirect non-primary merged issues to primary (unless suppressed)
        if (!NoRedirect && issue?.MergeSet is not null && issue.MergeSet.PrimaryIssueId != IssueId)
        {
            Navigation.NavigateTo($"/projects/{ProjectId}/issues/{issue.MergeSet.PrimaryIssueId}", replace: true);
            return;
        }

        _activeTab = TabParam?.ToLower() switch
        {
            "suggestedevent" => issue?.SuggestedEvent is not null ? Tab.SuggestedEvent : Tab.Events,
            "events"         => Tab.Events,
            "activity"       => Tab.Activity,
            "similar"        => Tab.Similar,
            _                => issue?.SuggestedEvent is not null ? Tab.SuggestedEvent : Tab.Events
        };

        loading = false;
    }

    private async Task LoadIssue()
    {
        try
        {
            issue = await IssueService.GetIssueDetailAsync(IssueId);
            if (issue?.SuggestedEvent is not null)
            {
                var combined = await EventService.GetIssueEventDetailAsync(IssueId, issue.SuggestedEvent.Id);
                eventDetail = combined?.Event;
                navigation = issue.MergeSet is not null && issue.MergeSet.PrimaryIssueId == IssueId && combined is not null
                    ? await EventService.GetMergeGroupEventNavigationAsync(issue.MergeSet.Id, issue.SuggestedEvent.Id)
                    : combined?.Navigation;
                breadcrumbs = combined?.Breadcrumbs ?? [];
            }
            else
            {
                eventDetail = null;
                navigation = null;
                breadcrumbs = [];
            }

            isBookmarked = await BookmarkService.IsBookmarkedAsync(IssueId, currentUserId);
        }
        catch
        {
            issue = null;
            eventDetail = null;
            navigation = null;
            breadcrumbs = [];
        }
    }

    private async Task ToggleBookmark()
    {
        isBookmarked = await BookmarkService.ToggleBookmarkAsync(IssueId, currentUserId);
    }

    private async Task NavigateEvent(long eventId)
    {
        eventNavigating = true;
        try
        {
            var combined = await EventService.GetIssueEventDetailAsync(IssueId, eventId);
            if (combined is not null)
            {
                eventDetail = combined.Event;
                navigation = issue?.MergeSet is not null && issue.MergeSet.PrimaryIssueId == IssueId
                    ? await EventService.GetMergeGroupEventNavigationAsync(issue.MergeSet.Id, eventId)
                    : combined.Navigation;
                breadcrumbs = combined.Breadcrumbs;
            }
        }
        catch
        {
            // Keep current event on navigation failure
        }
        finally
        {
            eventNavigating = false;
        }
    }

    private async Task OnIssueChanged<T>(T _) => await LoadIssue();

    private static string GetTabLabel(Tab tab) => tab switch
    {
        Tab.SuggestedEvent => "Event",
        Tab.Events         => "Events",
        Tab.Activity       => "Activity",
        Tab.Similar        => "Similar",
        _                  => tab.ToString()
    };
}
