@page "/projects/{ProjectId:int}/issues"
@attribute [Authorize]
@rendermode InteractiveWebAssembly
@using Sigil.Application.Models.Issues
@inject IIssueService IssueService
@inject NavigationManager Navigation
@using System.Net

<PageTitle>Issues — Sigil</PageTitle>

<PageBreadcrumb Items="@([ new PageBreadcrumb.BreadcrumbItem("Projects", "/"), new PageBreadcrumb.BreadcrumbItem("Issues") ])" />

<div class="space-y-4">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Issues</h1>
        @if (Response is not null)
        {
            <span class="text-sm opacity-60">@Response.TotalCount total</span>
        }
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-2 items-center">
        <!-- Status tabs -->
        <form class="filter">
            <input class="btn btn-sm btn-square" type="reset" value="x" @onclick="() => SetStatusFilter(null)"/>
            @foreach (var s in statusOptions)
            {
                <input class="btn btn-sm" type="radio" name="status" @onclick="() => SetStatusFilter(s.Value)" aria-label="@s.Label"/>
            }
        </form>

        <!-- Severity filter -->
        
        <label class="select select-sm w-48">
            <span class="label">Severity</span>
            <select value="@severityFilter" @onchange="OnSeverityChanged">
                <option value="">All</option>
                @foreach (var sev in Enum.GetValues<Severity>())
                {
                    <option value="@sev">@sev</option>
                }
            </select>
        </label>

        <!-- Sort -->
        <label class="select select-sm w-48">
            <span class="label">Sort</span>
            
            <select value="@sortBy" @onchange="OnSortChanged">
                @foreach (var opt in sortOptions)
                {
                    <option value="@opt.Value">@opt.Label</option>
                }
            </select>
        </label>

        <!-- Search -->
        <input type="text" placeholder="Search issues..." class="input input-sm w-48"
               @bind="searchText" @bind:event="oninput" @onkeydown="OnSearchKeyDown" />
    </div>

    <!-- Content -->
    @if (loading)
    {
        <div class="flex justify-center py-16">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (projectNotFound)
    {
        <EmptyState Title="Project not found" Description="This project does not exist or you do not have access to it." />
    }
    else if (Response is null || Response.Items.Count == 0)
    {
        <EmptyState Title="No issues found" Description="Try adjusting your filters or wait for events to come in." />
    }
    else
    {
        <div class="overflow-x-auto">
            <table class="table table-zebra table-sm">
                <thead>
                    <tr>
                        <th>Issue</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th class="text-right">Events</th>
                        <th>Last Seen</th>
                        <th>Assigned</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var issue in Response.Items)
                    {
                        <tr class="hover:bg-base-300 relative cursor-pointer">
                            <td>
                                <a href="/projects/@ProjectId/issues/@issue.Id" class="stretched-link" ></a>
                                <div class="font-semibold">
                                    @if (!string.IsNullOrEmpty(issue.ExceptionType))
                                    {
                                        <span class="opacity-80">@issue.ExceptionType: </span>
                                    }
                                    @issue.Title
                                </div>
                                @if (!string.IsNullOrEmpty(issue.Culprit))
                                {
                                    <div class="text-xs opacity-60">@issue.Culprit</div>
                                }
                            </td>
                            <td><SeverityBadge Level="issue.Level" /></td>
                            <td><StatusBadge Status="issue.Status" /></td>
                            <td class="text-right font-mono">@issue.OccurrenceCount</td>
                            <td><RelativeTime Value="issue.LastSeen" /></td>
                            <td class="text-sm opacity-70">@(issue.AssignedToName ?? "—")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <Pagination Page="currentPage" TotalCount="Response.TotalCount" PageSize="PageSize"
                    OnPageChanged="OnPageChanged" />
    }
</div>

@code {
    [Parameter] public int ProjectId { get; set; }
    [SupplyParameterFromQuery(Name = "page")] public int PageParam { get; set; } = 1;

    private const int PageSize = 50;
    [PersistentState] public PagedResponse<IssueSummary>? Response { get; set; }
    private bool loading = true;
    private bool projectNotFound;
    private int currentPage = 1;

    // Filters
    private IssueStatus? statusFilter;
    private string severityFilter = "";
    private IssueSortBy sortBy = IssueSortBy.LastSeen;
    private string searchText = "";

    private static readonly (string Label, IssueStatus? Value)[] statusOptions =
    [
        ("Open", IssueStatus.Open),
        ("Resolved", IssueStatus.Resolved),
        ("Ignored", IssueStatus.Ignored),
    ];

    private static readonly (string Label, IssueSortBy Value)[] sortOptions =
    [
        ("Last Seen", IssueSortBy.LastSeen),
        ("First Seen", IssueSortBy.FirstSeen),
        ("Occurrences", IssueSortBy.OccurrenceCount),
        ("Priority", IssueSortBy.Priority),
    ];

    protected override async Task OnParametersSetAsync()
    {
        var targetPage = Math.Max(1, PageParam);

        // Restored from SSR with the same page — skip re-fetch
        if (Response is not null && Response.Page == targetPage)
        {
            currentPage = targetPage;
            loading = false;
            return;
        }

        currentPage = targetPage;
        await LoadIssues();
    }

    private async Task LoadIssues()
    {
        loading = true;
        try
        {
            Severity? level = null;
            if (!string.IsNullOrEmpty(severityFilter) && Enum.TryParse<Severity>(severityFilter, out var parsed))
                level = parsed;

            var query = new IssueQueryParams
            {
                Status = statusFilter,
                Level = level,
                SortBy = sortBy,
                SortDescending = true,
                Search = string.IsNullOrWhiteSpace(searchText) ? null : searchText,
                Page = currentPage,
                PageSize = PageSize
            };

            Response = await IssueService.GetIssueSummariesAsync(ProjectId, query);
            projectNotFound = false;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.NotFound)
        {
            projectNotFound = true;
            Response = null;
        }
        catch
        {
            Response = null;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task SetStatusFilter(IssueStatus? status)
    {
        statusFilter = status;
        currentPage = 1;
        await LoadIssues();
    }

    private async Task OnSeverityChanged(ChangeEventArgs e)
    {
        severityFilter = e.Value?.ToString() ?? "";
        currentPage = 1;
        await LoadIssues();
    }

    private async Task OnSortChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<IssueSortBy>(e.Value?.ToString(), out var sort))
        {
            sortBy = sort;
            currentPage = 1;
            await LoadIssues();
        }
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 1;
            await LoadIssues();
        }
    }

    private void OnPageChanged(int newPage) =>
        Navigation.NavigateTo($"/projects/{ProjectId}/issues?page={newPage}");
}
