@page "/projects/{ProjectId:int}/issues"
@attribute [Authorize]
@using Sigil.Application.Models.Issues
@using Sigil.Domain
@inject IIssueService IssueService
@inject IBookmarkService BookmarkService
@inject IRecommendationService RecommendationService
@inject NavigationManager Navigation

<PageTitle>Issues — Sigil</PageTitle>

<PageBreadcrumb Items="@([ new PageBreadcrumb.BreadcrumbItem("Projects", "/"), new PageBreadcrumb.BreadcrumbItem("Issues") ])" />

<!-- Recommendations banner -->
@if (recommendationCount > 0)
{
    <div class="alert alert-warning shadow-sm mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
        </svg>
        <span>
            <strong>@recommendationCount @(recommendationCount == 1 ? "recommendation" : "recommendations")</strong>
            to improve your error tracking setup.
        </span>
        <a href="@($"/projects/{ProjectId}/issues/recommendations")" class="btn btn-sm btn-warning">View</a>
    </div>
}

<div class="bg-base-100 p-4 space-y-4">


    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Issues</h1>
        @if (Response is not null)
        {
            <span class="text-sm opacity-60">@Response.TotalCount total</span>
        }
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-2 items-center">
        <!-- Status tabs -->
        <form >
            <input class="btn btn-sm btn-square @(statusFilter == null ? "bg-primary" : "")" type="reset" value="All" @onclick="() => SetStatusFilter(null)"/>
            @foreach (var s in statusOptions)
            {
                <input class="btn btn-sm" type="radio" name="status" checked="@(statusFilter == s.Value)" @onclick="() => SetStatusFilter(s.Value)" aria-label="@s.Label"/>
            }
        </form>
        
        <!-- Bookmarked filter -->
        <button class="btn btn-sm @(bookmarkedFilter ? "btn-warning" : "")"
                @onclick="ToggleBookmarkedFilter" title="@(bookmarkedFilter ? "Showing bookmarked" : "Show bookmarked")">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="@(bookmarkedFilter ? "currentColor" : "none")" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
            </svg>
        </button>

        <!-- Severity filter -->
        <label class="select select-sm w-48">
            <span class="label">Severity</span>
            <select value="@severityFilter" @onchange="OnSeverityChanged">
                <option value="">All</option>
                @foreach (var sev in Enum.GetValues<Severity>())
                {
                    <option value="@sev">@sev</option>
                }
            </select>
        </label>

        <!-- Sort -->
        <label class="select select-sm w-48">
            <span class="label">Sort</span>
            <select value="@sortBy" @onchange="OnSortChanged">
                @foreach (var opt in sortOptions)
                {
                    <option value="@opt.Value">@opt.Label</option>
                }
            </select>
        </label>
        
        <!-- Search -->
        <input type="text" placeholder="Search issues..." class="input input-sm flex-1 min-w-48"
               @bind="searchText" @bind:event="oninput" @onkeydown="OnSearchKeyDown" />
    </div>

    <!-- Active tag filter chips -->
    @{
        var activeTagFilters = ParseTagFiltersFromSearch(SearchParam);
    }
    @if (activeTagFilters.Count > 0)
    {
        <div class="flex flex-wrap gap-2">
            @foreach (var (key, value) in activeTagFilters)
            {
                <div class="badge badge-lg badge-outline gap-2">
                    <span class="font-mono">@key: @value</span>
                    <button class="btn btn-xs btn-circle btn-ghost" @onclick="ClearSearch" title="Remove filter">×</button>
                </div>
            }
        </div>
    }

    <!-- Content -->
    @if (loading)
    {
        <div class="flex justify-center py-16">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (projectNotFound)
    {
        <EmptyState Title="Project not found" Description="This project does not exist or you do not have access to it." />
    }
    else if (Response is null || Response.Items.Count == 0)
    {
        <EmptyState Title="No issues found" Description="Try adjusting your filters or wait for events to come in." />
    }
    else
    {
        <div class="overflow-x-auto">
            <table class="table table-zebra table-sm">
                <thead>
                    <tr>
                        <th class="w-8"></th>
                        <th>Issue</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th class="text-right">Events</th>
                        <th class="w-28">Last 14d</th>
                        <th>Last Seen</th>
                        <th>Assigned</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var issue in Response.Items)
                    {
                        var isMerged = issue.MergeSetId.HasValue;
                        var targetUrl = $"/projects/{ProjectId}/issues/{issue.Id}";
                        var isBookmarked = bookmarkedIssueIds.Contains(issue.Id);
                        <tr class="hover:bg-base-300 relative">
                            <td @onclick:stopPropagation="true">
                                <button class="btn btn-ghost btn-xs p-0" @onclick="() => ToggleIssueBookmark(issue.Id)"
                                        title="@(isBookmarked ? "Remove bookmark" : "Bookmark")">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 @(isBookmarked ? "text-warning" : "opacity-30")"
                                         fill="@(isBookmarked ? "currentColor" : "none")" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                    </svg>
                                </button>
                            </td>
                            <td>
                                <a href="@targetUrl" class="stretched-link after:start-12! cursor-pointer"></a>
                                <div class="font-semibold flex items-center gap-1.5">
                                    @if (issue.IsUnviewed)
                                    {
                                        <span class="w-2 h-2 rounded-full bg-primary shrink-0" title="New activity since your last visit"></span>
                                    }
                                    @if (isMerged && issue.MergeSetSize > 1)
                                    {
                                        <!-- Stacked layers icon for merged issues -->
                                        <span class="badge badge-sm badge-neutral gap-1" title="Merged issue group (@issue.MergeSetSize members)">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                            </svg>
                                            @issue.MergeSetSize
                                        </span>
                                    }
                                    @if (issue.SystemTagKeys is not null)
                                    {
                                        @foreach (var tagKey in issue.SystemTagKeys)
                                        {
                                            var label = tagKey[SystemTags.Prefix.Length..];
                                            var css = tagKey == SystemTags.Regression ? "badge-error"
                                                    : tagKey == SystemTags.HighVolume  ? "badge-info"
                                                    : "badge-warning";
                                            <span class="badge badge-sm text-nowrap @css">@label</span>
                                        }
                                    }
                                    @if (!string.IsNullOrEmpty(issue.ExceptionType))
                                    {
                                        <span class="opacity-80">@issue.ExceptionType: </span>
                                    }
                                    @if (!string.IsNullOrEmpty(issue.Title))
                                    {
                                        <p class="line-clamp-1">@issue.Title</p>
                                    }
                                    else
                                    {
                                        <p class="line-clamp-1 opacity-50 italic">No message</p>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(issue.Culprit))
                                {
                                    <div class="text-xs opacity-60">@issue.Culprit</div>
                                }
                            </td>
                            <td><SeverityBadge Level="issue.Level" /></td>
                            <td><StatusBadge Status="issue.Status" /></td>
                            <td class="text-sm @(@issue.Priority == Priority.Low? "opacity-70" : "")">@issue.Priority</td>
                            <td class="text-right font-mono">@issue.OccurrenceCount</td>
                            <td class="opacity-60">
                                @if (_histograms.TryGetValue(issue.Id, out var hist))
                                {
                                    <Sparkline Data="hist" Width="100" Height="20" />
                                }
                            </td>
                            <td><RelativeTime Value="issue.LastSeen" /></td>
                            <td class="text-sm opacity-70">@(issue.AssignedToName ?? "—")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <Pagination Page="currentPage" TotalCount="Response.TotalCount" PageSize="PageSize"/>
    }
</div>

@code {
    [Parameter] public int ProjectId { get; set; }
    [SupplyParameterFromQuery(Name = "page")] public int PageParam { get; set; } = 1;
    [SupplyParameterFromQuery(Name = "q")] public string? SearchParam { get; set; }

    private const int PageSize = 50;
    [PersistentState] public PagedResponse<IssueSummary>? Response { get; set; }
    private bool loading = true;
    private bool projectNotFound;
    private int currentPage = 1;
    private string? _lastSearchParam; // track URL search to detect changes

    // Filters
    private IssueStatus? statusFilter = IssueStatus.Open;
    private string severityFilter = "";
    private IssueSortBy sortBy = IssueSortBy.LastSeen;
    private string searchText = "";
    private bool bookmarkedFilter;

    // Bookmark state: IDs of bookmarked issues in the current page
    private HashSet<int> bookmarkedIssueIds = [];
    private Guid currentUserId;

    // Histograms: issueId → daily event counts for last 14 days
    private Dictionary<int, List<int>> _histograms = [];

    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = null!;

    private int recommendationCount;

    private static readonly (string Label, IssueStatus? Value)[] statusOptions =
    [
        ("Open", IssueStatus.Open),
        ("Resolved", IssueStatus.Resolved),
        ("Next Release", IssueStatus.ResolvedInFuture),
        ("Ignored", IssueStatus.Ignored),
    ];

    private static readonly (string Label, IssueSortBy Value)[] sortOptions =
    [
        ("Last Seen", IssueSortBy.LastSeen),
        ("First Seen", IssueSortBy.FirstSeen),
        ("Occurrences", IssueSortBy.OccurrenceCount),
        ("Priority", IssueSortBy.Priority),
    ];

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthState;
        var userIdStr = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        currentUserId = userIdStr is not null ? Guid.Parse(userIdStr) : Guid.Empty;

        var targetPage = Math.Max(1, PageParam);
        var searchChanged = SearchParam != _lastSearchParam;
        _lastSearchParam = SearchParam;

        // Sync searchText from URL on navigation (e.g. from a TagLink click)
        if (searchChanged)
            searchText = SearchParam ?? "";

        if (Response is not null && Response.Page == targetPage && !searchChanged)
        {
            currentPage = targetPage;
            loading = false;
            return;
        }

        currentPage = targetPage;
        await LoadIssues();
        StateHasChanged();
        recommendationCount = await RecommendationService.GetRecommendationCountAsync(ProjectId);
    }

    private async Task LoadIssues()
    {
        loading = true;
        try
        {
            Severity? level = null;
            if (!string.IsNullOrEmpty(severityFilter) && Enum.TryParse<Severity>(severityFilter, out var parsed))
                level = parsed;

            var query = new IssueQueryParams
            {
                Status = statusFilter,
                Level = level,
                SortBy = sortBy,
                SortDescending = true,
                Search = string.IsNullOrWhiteSpace(searchText) ? null : searchText,
                Page = currentPage,
                PageSize = PageSize,
                Bookmarked = bookmarkedFilter
            };

            Response = await IssueService.GetIssueSummariesAsync(ProjectId, query);

            // Load histograms in background (fire and don't block UI)
            _ = LoadHistogramsAsync(Response.Items.Select(i => i.Id).ToList());

            // Load bookmark states for visible issues
            var bookmarked = await BookmarkService.GetBookmarkedIssuesAsync(currentUserId);
            bookmarkedIssueIds = bookmarked.Select(i => i.Id).ToHashSet();
            projectNotFound = false;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            projectNotFound = true;
            Response = null;
        }
        catch
        {
            Response = null;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task SetStatusFilter(IssueStatus? status)
    {
        statusFilter = status;
        currentPage = 1;
        await LoadIssues();
    }

    private async Task OnSeverityChanged(ChangeEventArgs e)
    {
        severityFilter = e.Value?.ToString() ?? "";
        currentPage = 1;
        await LoadIssues();
    }

    private async Task OnSortChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<IssueSortBy>(e.Value?.ToString(), out var sort))
        {
            sortBy = sort;
            currentPage = 1;
            await LoadIssues();
        }
    }

    private void OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            ApplySearch();
    }

    private void ApplySearch()
    {
        string quary = string.IsNullOrWhiteSpace(searchText) ? "" : $"&q={Uri.EscapeDataString(searchText)}";
        Navigation.NavigateTo($"/projects/{ProjectId}/issues?page=1{quary}", forceLoad: false);
    }

    private async Task ToggleBookmarkedFilter()
    {
        bookmarkedFilter = !bookmarkedFilter;
        currentPage = 1;
        await LoadIssues();
    }

    private static List<(string Key, string Value)> ParseTagFiltersFromSearch(string? search)
    {
        if (string.IsNullOrWhiteSpace(search)) return [];
        var result = new List<(string, string)>();
        foreach (var part in search.Split(' ', StringSplitOptions.RemoveEmptyEntries))
        {
            var idx = part.IndexOf(':');
            if (idx > 0 && idx < part.Length - 1)
                result.Add((part[..idx], part[(idx + 1)..]));
        }
        return result;
    }

    private void ClearSearch()
    {
        searchText = "";
        Navigation.NavigateTo($"/projects/{ProjectId}/issues?page=1", forceLoad: false);
    }

    private async Task LoadHistogramsAsync(List<int> issueIds)
    {
        try
        {
            _histograms = await IssueService.GetBulkHistogramsAsync(issueIds);
            StateHasChanged();
        }
        catch { /* silently ignore histogram load failures */ }
    }

    private async Task ToggleIssueBookmark(int issueId)
    {
        var isNowBookmarked = await BookmarkService.ToggleBookmarkAsync(issueId, currentUserId);
        if (isNowBookmarked)
            bookmarkedIssueIds.Add(issueId);
        else
        {
            bookmarkedIssueIds.Remove(issueId);
            if (bookmarkedFilter)
                await LoadIssues();
        }
    }
}
